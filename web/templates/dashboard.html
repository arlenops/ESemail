<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.title}} - ESemail é‚®ä»¶æœåŠ¡ç®¡ç†</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/css/clean-modern.css" rel="stylesheet">
    <script src="/static/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/chart.js"></script>
    <script src="/static/js/notification.js"></script>
    <script src="/static/js/dashboard.js"></script>
    <script src="/static/js/mail.js"></script>
    
    <style>
        /* ä¿®å¤æ¨¡æ€æ¡†ä¸­ä¸‹æ‹‰èœå•è¢«é®æŒ¡çš„é—®é¢˜ */
        .modal-body {
            overflow: visible;
        }
        
        /* ç¡®ä¿ä¸‹æ‹‰èœå•åœ¨æ¨¡æ€æ¡†ä¸­æœ‰è¶³å¤Ÿçš„z-index */
        .modal .dropdown-menu,
        .modal .form-select {
            position: relative;
            z-index: 1060;
        }
        
        /* å½“ä¸‹æ‹‰èœå•å±•å¼€æ—¶æä¾›æ›´å¤šç©ºé—´ */
        .modal-dialog {
            margin-top: 1.75rem;
            margin-bottom: 1.75rem;
        }
        
        /* å¢åŠ ç”¨æˆ·æ¨¡æ€æ¡†çš„æœ€å°é«˜åº¦ä»¥å®¹çº³ä¸‹æ‹‰é€‰é¡¹ */
        #add-user-modal .modal-content {
            min-height: 500px;
        }
        
        /* ä¿®å¤ç”¨æˆ·æ¨¡æ€æ¡†ç‰¹æ®Šæ ·å¼ */
        #add-user-modal .modal-body {
            padding-bottom: 3rem;
            overflow: visible;
        }
        
        /* ç¡®ä¿selectä¸‹æ‹‰é€‰é¡¹å¯è§ */
        .form-select:focus {
            z-index: 1061;
        }
        
        /* é”å®šåŠŸèƒ½çš„æ ·å¼ */
        .nav-link.disabled {
            color: #6c757d !important;
            pointer-events: none;
            opacity: 0.5;
        }
        
        .nav-link.disabled:hover {
            background-color: transparent !important;
        }
        
        /* ä¸ºåŸŸåé€‰æ‹©æ¡†æ·»åŠ ç‰¹æ®Šæ ·å¼ç¡®ä¿å¯è§ */
        #user-domain {
            position: relative;
            z-index: 1061;
        }
        
        /* ç¡®ä¿æ¨¡æ€æ¡†ä¸ä¼šè£å‰ªä¸‹æ‹‰å†…å®¹ */
        .modal.show .modal-dialog {
            transform: none;
        }
        
        /* ä¸ºä¸‹æ‹‰é€‰é¡¹æ·»åŠ æ›´é«˜çš„z-index */
        .form-select option {
            z-index: 1062;
        }
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <nav class="navbar navbar-expand-lg fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                ESemail ç®¡ç†æ§åˆ¶å°
            </a>
            <div class="navbar-nav ms-auto">
                <div class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle text-white" href="#" role="button" data-bs-toggle="dropdown">
                        <i class="fas fa-user-circle"></i> ç®¡ç†å‘˜
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="changePassword()"><i class="fas fa-key"></i> ä¿®æ”¹å¯†ç </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> é€€å‡º</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid" style="padding-top: 70px;">
        <div class="row">
            <!-- ä¾§è¾¹æ  -->
            <nav class="col-md-3 col-lg-2 d-md-block sidebar collapse" id="sidebar">
                <div class="sidebar-sticky">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link active" href="#dashboard" data-section="dashboard">
                                <i class="fas fa-chart-line"></i>
                                ç³»ç»Ÿç›‘æ§
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link {{if not .unlock_status.domain_config}}disabled{{end}}"
                               href="{{if .unlock_status.domain_config}}#domains{{else}}javascript:void(0){{end}}"
                               data-section="{{if .unlock_status.domain_config}}domains{{else}}locked{{end}}"
                               {{if not .unlock_status.domain_config}}onclick="showLockMessage('åŸŸåç®¡ç†', 'ç³»ç»Ÿåˆå§‹åŒ–')"{{end}}>
                                <i class="fas fa-globe"></i>
                                åŸŸåç®¡ç†
                                {{if not .unlock_status.domain_config}}<i class="fas fa-lock ms-1 text-muted"></i>{{end}}
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link {{if not .unlock_status.ssl_config}}disabled{{end}}"
                               href="{{if .unlock_status.ssl_config}}#certificates{{else}}javascript:void(0){{end}}"
                               data-section="{{if .unlock_status.ssl_config}}certificates{{else}}locked{{end}}"
                               {{if not .unlock_status.ssl_config}}onclick="showLockMessage('è¯ä¹¦ç®¡ç†', 'DNSéªŒè¯')"{{end}}>
                                <i class="fas fa-shield-alt"></i>
                                è¯ä¹¦ç®¡ç†
                                {{if not .unlock_status.ssl_config}}<i class="fas fa-lock ms-1 text-muted"></i>{{end}}
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link {{if not .unlock_status.user_mgmt}}disabled{{end}}"
                               href="{{if .unlock_status.user_mgmt}}#users{{else}}javascript:void(0){{end}}"
                               data-section="{{if .unlock_status.user_mgmt}}users{{else}}locked{{end}}"
                               {{if not .unlock_status.user_mgmt}}onclick="showLockMessage('ç”¨æˆ·ç®¡ç†', 'SSLè¯ä¹¦é…ç½®')"{{end}}>
                                <i class="fas fa-users"></i>
                                ç”¨æˆ·ç®¡ç†
                                {{if not .unlock_status.user_mgmt}}<i class="fas fa-lock ms-1 text-muted"></i>{{end}}
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link {{if not .unlock_status.mail_service}}disabled{{end}}"
                               href="{{if .unlock_status.mail_service}}#mail{{else}}javascript:void(0){{end}}"
                               data-section="{{if .unlock_status.mail_service}}mail{{else}}locked{{end}}"
                               {{if not .unlock_status.mail_service}}onclick="showLockMessage('é‚®ä»¶æœåŠ¡', 'ç”¨æˆ·ç®¡ç†')"{{end}}>
                                <i class="fas fa-envelope"></i>
                                é‚®ä»¶å†å²
                                {{if not .unlock_status.mail_service}}<i class="fas fa-lock ms-1 text-muted"></i>{{end}}
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#system" data-section="system">
                                <i class="fas fa-cog"></i>
                                ç³»ç»Ÿè®¾ç½®
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- ä¸»å†…å®¹åŒºåŸŸ -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <!-- ç³»ç»Ÿç›‘æ§é¢æ¿ -->
                <div id="dashboard-section" class="section-content">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3">
                        <h1 class="h2">ç³»ç»Ÿç›‘æ§</h1>
                        <div class="btn-toolbar mb-2 mb-md-0">
                            <button type="button" class="btn btn-outline-primary btn-sm" id="refresh-dashboard">
                                <i class="fas fa-sync-alt"></i> åˆ·æ–°
                            </button>
                        </div>
                    </div>

                    <!-- ç»Ÿè®¡å¡ç‰‡ -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-number" id="total-users">--</div>
                                <div class="stat-label">æ€»ç”¨æˆ·æ•°</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card" style="background: var(--gradient-success);">
                                <div class="stat-number" id="active-domains">--</div>
                                <div class="stat-label">æ´»è·ƒåŸŸå</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card" style="background: var(--gradient-warning);">
                                <div class="stat-number" id="mail-queue">--</div>
                                <div class="stat-label">é‚®ä»¶é˜Ÿåˆ—</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card" style="background: var(--gradient-danger);">
                                <div class="stat-number" id="system-load">--</div>
                                <div class="stat-label">ç³»ç»Ÿè´Ÿè½½</div>
                            </div>
                        </div>
                    </div>

                    <!-- æœåŠ¡çŠ¶æ€ -->
                    <div class="row mb-4">
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header">
                                    <i class="fas fa-server"></i> æœåŠ¡çŠ¶æ€
                                </div>
                                <div class="card-body">
                                    <div id="services-list" class="row">
                                        <div class="col-12 text-center">
                                            <div class="loading-spinner"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="system-info">
                                <h5 class="mb-3"><i class="fas fa-info-circle"></i> ç³»ç»Ÿä¿¡æ¯</h5>
                                <div class="info-item">
                                    <span class="info-label">CPU ä½¿ç”¨ç‡</span>
                                    <span class="info-value" id="cpu-usage">--</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">å†…å­˜ä½¿ç”¨ç‡</span>
                                    <span class="info-value" id="memory-usage">--</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">ç£ç›˜ä½¿ç”¨ç‡</span>
                                    <span class="info-value" id="disk-usage">--</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">ç³»ç»Ÿè¿è¡Œæ—¶é—´</span>
                                    <span class="info-value" id="uptime">--</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">è´Ÿè½½å¹³å‡</span>
                                    <span class="info-value" id="load-average">--</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ç³»ç»Ÿåˆå§‹åŒ–é¢æ¿ -->
                    <div class="row">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <i class="fas fa-rocket"></i> ç³»ç»Ÿåˆå§‹åŒ–
                                    {{if .unlock_status.system_init}}
                                        <span class="badge bg-success float-end">å·²å®Œæˆ</span>
                                    {{else}}
                                        <span class="badge bg-warning float-end">å¾…å®Œæˆ</span>
                                    {{end}}
                                </div>
                                <div class="card-body">
                                    {{if .unlock_status.system_init}}
                                        <p class="text-muted mb-3">âœ… ç³»ç»Ÿå·²æˆåŠŸåˆå§‹åŒ–ï¼Œé‚®ä»¶æœåŠ¡å·²å‡†å¤‡å°±ç»ª</p>
                                        <div class="alert alert-success">
                                            <strong>ä¸‹ä¸€æ­¥ï¼š</strong> 
                                            {{if not .unlock_status.domain_config}}
                                                å‰å¾€åŸŸåç®¡ç†é…ç½®æ‚¨çš„ç¬¬ä¸€ä¸ªé‚®ä»¶åŸŸå
                                            {{else if not .unlock_status.dns_verified}}
                                                å®ŒæˆDNSè§£æéªŒè¯
                                            {{else if not .unlock_status.ssl_config}}
                                                é…ç½®SSLè¯ä¹¦
                                            {{else if not .unlock_status.user_mgmt}}
                                                åˆ›å»ºç¬¬ä¸€ä¸ªé‚®ä»¶ç”¨æˆ·
                                            {{else if not .unlock_status.mail_service}}
                                                å¯ç”¨é‚®ä»¶æœåŠ¡åŠŸèƒ½
                                            {{else}}
                                                æ‰€æœ‰è®¾ç½®å·²å®Œæˆï¼ğŸ‰
                                            {{end}}
                                        </div>
                                    {{else}}
                                        <p class="text-muted mb-3">é¦–æ¬¡ä½¿ç”¨æˆ–é‡æ–°é…ç½®ç³»ç»Ÿæ—¶ï¼Œè¯·æ‰§è¡Œç³»ç»Ÿåˆå§‹åŒ–ä»¥è®¾ç½®æ‰€æœ‰é‚®ä»¶æœåŠ¡ã€‚</p>
                                        <button class="btn btn-primary" id="init-system" onclick="initializeSystem()">
                                            <i class="fas fa-play"></i> å¼€å§‹åˆå§‹åŒ–
                                        </button>
                                    {{end}}
                                    <div id="init-progress" class="mt-3" style="display: none;">
                                        <div class="progress mb-3">
                                            <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                                        </div>
                                        <div id="init-steps"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- åŸŸåç®¡ç†é¡µé¢ -->
                <div id="domains-section" class="section-content" style="display: none;">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3">
                        <h1 class="h2">åŸŸåç®¡ç†</h1>
                        <div class="btn-toolbar mb-2 mb-md-0">
                            <button type="button" class="btn btn-success" onclick="refreshDomains()">
                                <i class="fas fa-sync-alt"></i> åˆ·æ–°
                            </button>
                            <button type="button" class="btn btn-primary ms-2" data-bs-toggle="modal" data-bs-target="#add-domain-modal">
                                <i class="fas fa-plus"></i> æ·»åŠ åŸŸå
                            </button>
                        </div>
                    </div>
                    
                    <!-- åŸŸååˆ—è¡¨å®¹å™¨ -->
                    <div id="domains-list">
                        <div class="text-center py-4">
                            <div class="loading-spinner mb-3"></div>
                            <p class="text-muted">æ­£åœ¨åŠ è½½åŸŸååˆ—è¡¨...</p>
                        </div>
                    </div>
                    
                    <!-- ç©ºçŠ¶æ€æç¤º -->
                    <div id="domains-empty-state" class="empty-state" style="display: none;">
                        <i class="fas fa-globe"></i>
                        <h3>æš‚æ— åŸŸå</h3>
                        <p>ç‚¹å‡»"æ·»åŠ åŸŸå"æŒ‰é’®å¼€å§‹é…ç½®æ‚¨çš„ç¬¬ä¸€ä¸ªé‚®ä»¶åŸŸå</p>
                        <button type="button" class="btn btn-primary mt-3" data-bs-toggle="modal" data-bs-target="#add-domain-modal">
                            <i class="fas fa-plus"></i> æ·»åŠ åŸŸå
                        </button>
                    </div>
                </div>

                <!-- ç”¨æˆ·ç®¡ç†é¡µé¢ -->
                <div id="users-section" class="section-content" style="display: none;">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3">
                        <h1 class="h2">ç”¨æˆ·ç®¡ç†</h1>
                        <div class="btn-toolbar mb-2 mb-md-0">
                            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#add-user-modal">
                                <i class="fas fa-user-plus"></i> æ·»åŠ ç”¨æˆ·
                            </button>
                        </div>
                    </div>
                    <!-- ç”¨æˆ·åˆ—è¡¨å®¹å™¨ -->
                    <div id="users-list">
                        <div class="text-center py-4">
                            <div class="loading-spinner mb-3"></div>
                            <p class="text-muted">æ­£åœ¨åŠ è½½ç”¨æˆ·åˆ—è¡¨...</p>
                        </div>
                    </div>
                    
                    <!-- ç©ºçŠ¶æ€æç¤º -->
                    <div id="users-empty-state" class="empty-state" style="display: none;">
                        <i class="fas fa-users"></i>
                        <h3>æš‚æ— ç”¨æˆ·</h3>
                        <p>ç‚¹å‡»"æ·»åŠ ç”¨æˆ·"æŒ‰é’®å¼€å§‹åˆ›å»ºæ‚¨çš„ç¬¬ä¸€ä¸ªé‚®ä»¶ç”¨æˆ·</p>
                        <button type="button" class="btn btn-primary mt-3" data-bs-toggle="modal" data-bs-target="#add-user-modal">
                            <i class="fas fa-user-plus"></i> æ·»åŠ ç”¨æˆ·
                        </button>
                    </div>
                </div>

                <!-- é‚®ä»¶ç®¡ç†é¡µé¢ -->
                <div id="mail-section" class="section-content" style="display: none;">
                    <!-- Tab å¯¼èˆª -->
                    <ul class="nav nav-tabs mb-3" id="mailTabs">
                        <li class="nav-item">
                            <a class="nav-link active" data-bs-toggle="tab" href="#mail-history">é‚®ä»¶å†å²</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#send-mail">å‘é€é‚®ä»¶</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#mail-status">é‚®ä»¶æœåŠ¡çŠ¶æ€</a>
                        </li>
                    </ul>

                    <!-- Tab å†…å®¹ -->
                    <div class="tab-content">
                        <!-- é‚®ä»¶å†å² Tab -->
                        <div class="tab-pane fade show active" id="mail-history">
                            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center mb-3">
                                <h3>é‚®ä»¶å†å²</h3>
                                <div class="btn-toolbar">
                                    <div class="input-group me-2">
                                        <input type="date" class="form-control" id="search-start-date" placeholder="å¼€å§‹æ—¥æœŸ">
                                        <input type="date" class="form-control" id="search-end-date" placeholder="ç»“æŸæ—¥æœŸ">
                                        <button class="btn btn-outline-primary" type="button" onclick="searchMails()">
                                            <i class="fas fa-search"></i> æœç´¢
                                        </button>
                                    </div>
                                    <button type="button" class="btn btn-success" onclick="refreshMailHistory()">
                                        <i class="fas fa-sync-alt"></i> åˆ·æ–°
                                    </button>
                                </div>
                            </div>
                            
                            <!-- é‚®ä»¶åˆ—è¡¨ -->
                            <div class="card">
                                <div class="card-body">
                                    <div id="mail-history-table">
                                        <table class="table table-striped table-hover">
                                            <thead>
                                                <tr>
                                                    <th>æ—¶é—´</th>
                                                    <th>å‘ä»¶äºº</th>
                                                    <th>æ”¶ä»¶äºº</th>
                                                    <th>ä¸»é¢˜</th>
                                                    <th>çŠ¶æ€</th>
                                                    <th>æ–¹å‘</th>
                                                    <th>å¤§å°</th>
                                                    <th>æ“ä½œ</th>
                                                </tr>
                                            </thead>
                                            <tbody id="mail-history-body">
                                                <tr>
                                                    <td colspan="8" class="text-center text-muted py-4">
                                                        <i class="fas fa-envelope fa-2x mb-2"></i><br>
                                                        æš‚æ— é‚®ä»¶è®°å½•ï¼Œç‚¹å‡»åˆ·æ–°è·å–æœ€æ–°æ•°æ®
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- å‘é€é‚®ä»¶ Tab -->
                        <div class="tab-pane fade" id="send-mail">
                            <h3>å‘é€é‚®ä»¶</h3>
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="card">
                                        <div class="card-body">
                                            <form id="send-mail-form">
                                                <div class="mb-3">
                                                    <label for="mail-from" class="form-label">å‘ä»¶äºº</label>
                                                    <select class="form-select" id="mail-from" required>
                                                        <option value="">é€‰æ‹©å‘ä»¶äººé‚®ç®±</option>
                                                    </select>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="mail-to" class="form-label">æ”¶ä»¶äºº</label>
                                                    <input type="email" class="form-control" id="mail-to" 
                                                           placeholder="user@example.com" required>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="mail-subject" class="form-label">ä¸»é¢˜</label>
                                                    <input type="text" class="form-control" id="mail-subject" 
                                                           placeholder="é‚®ä»¶ä¸»é¢˜" required>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="mail-body" class="form-label">é‚®ä»¶å†…å®¹</label>
                                                    <textarea class="form-control" id="mail-body" rows="8" 
                                                              placeholder="è¯·è¾“å…¥é‚®ä»¶å†…å®¹..." required></textarea>
                                                </div>
                                                <div class="d-flex justify-content-between">
                                                    <button type="button" class="btn btn-outline-secondary" onclick="clearMailForm()">
                                                        <i class="fas fa-trash"></i> æ¸…ç©º
                                                    </button>
                                                    <button type="submit" class="btn btn-primary">
                                                        <i class="fas fa-paper-plane"></i> å‘é€é‚®ä»¶
                                                    </button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card">
                                        <div class="card-header">
                                            <i class="fas fa-info-circle"></i> å‘é€æç¤º
                                        </div>
                                        <div class="card-body">
                                            <ul class="list-unstyled">
                                                <li><i class="fas fa-check text-success"></i> æ”¯æŒæœ¬åœ°åŸŸåå’Œå¤–éƒ¨é‚®ä»¶</li>
                                                <li><i class="fas fa-check text-success"></i> è‡ªåŠ¨å¤„ç†é‚®ä»¶é˜Ÿåˆ—</li>
                                                <li><i class="fas fa-check text-success"></i> å¤±è´¥é‡è¯•æœºåˆ¶</li>
                                                <li><i class="fas fa-check text-success"></i> å®Œæ•´çš„å‘é€è®°å½•</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- é‚®ä»¶æœåŠ¡çŠ¶æ€ Tab -->
                        <div class="tab-pane fade" id="mail-status">
                            <h3>é‚®ä»¶æœåŠ¡çŠ¶æ€</h3>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <i class="fas fa-server"></i> æœåŠ¡çŠ¶æ€
                                        </div>
                                        <div class="card-body" id="mail-server-status">
                                            <div class="text-center py-3">
                                                <i class="fas fa-spinner fa-spin"></i> åŠ è½½ä¸­...
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <i class="fas fa-list"></i> é‚®ä»¶é˜Ÿåˆ—
                                        </div>
                                        <div class="card-body" id="mail-queue-status">
                                            <div class="text-center py-3">
                                                <i class="fas fa-spinner fa-spin"></i> åŠ è½½ä¸­...
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- è¯ä¹¦ç®¡ç†é¡µé¢ -->
                <div id="certificates-section" class="section-content" style="display: none;">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3">
                        <h1 class="h2">è¯ä¹¦ç®¡ç†</h1>
                        <div class="btn-toolbar mb-2 mb-md-0">
                            <button type="button" class="btn btn-success" onclick="refreshCertificates()">
                                <i class="fas fa-sync-alt"></i> åˆ·æ–°
                            </button>
                            <button type="button" class="btn btn-primary ms-2" data-bs-toggle="modal" data-bs-target="#issue-cert-modal">
                                <i class="fas fa-certificate"></i> ç­¾å‘è¯ä¹¦
                            </button>
                        </div>
                    </div>
                    
                    <!-- è¯ä¹¦åˆ—è¡¨å®¹å™¨ -->
                    <div id="certificates-list">
                        <div class="text-center py-4">
                            <div class="loading-spinner mb-3"></div>
                            <p class="text-muted">æ­£åœ¨åŠ è½½è¯ä¹¦åˆ—è¡¨...</p>
                        </div>
                    </div>
                    
                    <!-- ç©ºçŠ¶æ€æç¤º -->
                    <div id="certificates-empty-state" class="empty-state" style="display: none;">
                        <i class="fas fa-shield-alt"></i>
                        <h3>æš‚æ— è¯ä¹¦</h3>
                        <p>ç‚¹å‡»"ç­¾å‘è¯ä¹¦"æŒ‰é’®ä¸ºæ‚¨çš„åŸŸåç”³è¯·SSL/TLSè¯ä¹¦</p>
                        <button type="button" class="btn btn-primary mt-3" data-bs-toggle="modal" data-bs-target="#issue-cert-modal">
                            <i class="fas fa-certificate"></i> ç­¾å‘è¯ä¹¦
                        </button>
                    </div>
                </div>

                <!-- ç³»ç»Ÿè®¾ç½®é¡µé¢ -->
                <div id="system-section" class="section-content" style="display: none;">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3">
                        <h1 class="h2">ç³»ç»Ÿè®¾ç½®</h1>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <i class="fas fa-cog"></i> åŸºç¡€è®¾ç½®
                                </div>
                                <div class="card-body">
                                    <p class="text-muted">é…ç½®ç³»ç»ŸåŸºç¡€å‚æ•°å’Œé‚®ä»¶æœåŠ¡é€‰é¡¹</p>
                                    <button class="btn btn-outline-primary">
                                        <i class="fas fa-edit"></i> ç¼–è¾‘è®¾ç½®
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <i class="fas fa-shield-alt"></i> å®‰å…¨è®¾ç½®
                                </div>
                                <div class="card-body">
                                    <p class="text-muted">é…ç½®é˜²ç«å¢™è§„åˆ™å’Œå®‰å…¨ç­–ç•¥</p>
                                    <button class="btn btn-outline-primary">
                                        <i class="fas fa-lock"></i> å®‰å…¨é…ç½®
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        // è®¤è¯ä»¤ç‰Œç®¡ç†
        const authToken = localStorage.getItem('auth_token');
        
        // æ£€æŸ¥è®¤è¯çŠ¶æ€
        async function checkAuth() {
            if (!authToken) {
                console.log('æ²¡æœ‰æ‰¾åˆ°è®¤è¯ä»¤ç‰Œï¼Œè·³è½¬åˆ°ç™»å½•é¡µé¢');
                redirectToLogin();
                return false;
            }
            
            // éªŒè¯ä»¤ç‰Œæ˜¯å¦æœ‰æ•ˆ
            try {
                const response = await fetch('/api/v1/auth/me', {
                    headers: {
                        'Authorization': 'Bearer ' + authToken
                    }
                });
                
                if (!response.ok) {
                    console.log('è®¤è¯ä»¤ç‰Œæ— æ•ˆï¼Œè·³è½¬åˆ°ç™»å½•é¡µé¢');
                    redirectToLogin();
                    return false;
                }
                
                console.log('è®¤è¯ä»¤ç‰Œæœ‰æ•ˆ');
                return true;
            } catch (error) {
                console.error('éªŒè¯è®¤è¯ä»¤ç‰Œå¤±è´¥:', error);
                redirectToLogin();
                return false;
            }
        }
        
        // è·³è½¬åˆ°ç™»å½•é¡µé¢
        function redirectToLogin() {
            localStorage.removeItem('auth_token');
            localStorage.removeItem('auth_user');
            window.location.href = '/login';
        }
        
        // å¸¦è®¤è¯çš„APIè¯·æ±‚
        function apiRequest(url, options = {}) {
            if (!options.headers) {
                options.headers = {};
            }
            if (authToken) {
                options.headers['Authorization'] = 'Bearer ' + authToken;
            }
            options.headers['Content-Type'] = 'application/json';
            
            return fetch(url, options).then(response => {
                if (response.status === 401) {
                    redirectToLogin();
                    throw new Error('Authentication required');
                }
                return response;
            });
        }
        
        // ç™»å‡ºåŠŸèƒ½
        async function logout() {
            if (await showConfirm('ç¡®å®šè¦é€€å‡ºå—ï¼Ÿ', 'ç¡®è®¤é€€å‡º')) {
                apiRequest('/api/v1/auth/logout', { method: 'POST' })
                .finally(() => {
                    localStorage.removeItem('auth_token');
                    localStorage.removeItem('auth_user');
                    window.location.href = '/login';
                });
            }
        }
        
        // ä¿®æ”¹å¯†ç åŠŸèƒ½
        async function changePassword() {
            const oldPassword = await showPrompt('è¯·è¾“å…¥å½“å‰å¯†ç ï¼š', 'ä¿®æ”¹å¯†ç ', '', { inputType: 'password' });
            if (!oldPassword) return;

            const newPassword = await showPrompt('è¯·è¾“å…¥æ–°å¯†ç ï¼ˆè‡³å°‘8ä½ï¼‰ï¼š', 'è®¾ç½®æ–°å¯†ç ', '', { inputType: 'password' });
            if (!newPassword || newPassword.length < 8) {
                showAlert('æ–°å¯†ç é•¿åº¦è‡³å°‘8ä½', 'å¯†ç éªŒè¯å¤±è´¥', 'warning');
                return;
            }

            const confirmPassword = await showPrompt('è¯·ç¡®è®¤æ–°å¯†ç ï¼š', 'ç¡®è®¤æ–°å¯†ç ', '', { inputType: 'password' });
            if (newPassword !== confirmPassword) {
                showAlert('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´', 'å¯†ç éªŒè¯å¤±è´¥', 'warning');
                return;
            }

            apiRequest('/api/v1/auth/change-password', {
                method: 'POST',
                body: JSON.stringify({
                    old_password: oldPassword,
                    new_password: newPassword
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    showAlert('å¯†ç ä¿®æ”¹æˆåŠŸ', 'æ“ä½œæˆåŠŸ', 'success');
                } else {
                    showAlert('å¯†ç ä¿®æ”¹å¤±è´¥ï¼š' + data.error, 'æ“ä½œå¤±è´¥', 'error');
                }
            })
            .catch(error => {
                console.error('ä¿®æ”¹å¯†ç å¤±è´¥:', error);
                showAlert('ä¿®æ”¹å¯†ç å¤±è´¥', 'ç½‘ç»œé”™è¯¯', 'error');
            });
        }
        
        // é¡µé¢åˆ‡æ¢é€»è¾‘
        document.addEventListener('DOMContentLoaded', async function() {
            // æ£€æŸ¥è®¤è¯çŠ¶æ€
            if (!(await checkAuth())) {
                return;
            }
            
            // æ˜¾ç¤ºåŠŸèƒ½é”å®šæ¶ˆæ¯çš„å‡½æ•°
            window.showLockMessage = function(feature, requiredStep) {
                alert(`âš ï¸ ${feature}åŠŸèƒ½å°šæœªè§£é”\n\nè¯·å…ˆå®Œæˆï¼š${requiredStep}`);
            }
            
            // æ£€æŸ¥æ˜¯å¦éœ€è¦æ˜¾ç¤ºåˆå§‹åŒ–å¼¹çª—
            if ({{if not .is_initialized}}true{{else}}false{{end}}) {
                const modal = new bootstrap.Modal(document.getElementById('system-init-modal'), {
                    backdrop: 'static',
                    keyboard: false
                });
                modal.show();
            }
            
            const navLinks = document.querySelectorAll('.sidebar .nav-link');
            const sections = document.querySelectorAll('.section-content');

            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // æ›´æ–°å¯¼èˆªçŠ¶æ€
                    navLinks.forEach(l => l.classList.remove('active'));
                    this.classList.add('active');
                    
                    // æ˜¾ç¤ºå¯¹åº”é¡µé¢
                    const targetSection = this.getAttribute('data-section') + '-section';
                    sections.forEach(section => {
                        section.style.display = 'none';
                    });
                    
                    const target = document.getElementById(targetSection);
                    if (target) {
                        target.style.display = 'block';
                        target.classList.add('fade-in-up');
                    }
                    
                    // æ ¹æ®ä¸åŒé¡µé¢åŠ è½½å¯¹åº”æ•°æ®
                    if (targetSection === 'dashboard-section') {
                        loadDashboardData();
                    } else if (targetSection === 'domains-section') {
                        loadDomains();
                    } else if (targetSection === 'users-section') {
                        loadUsers();
                        loadDomainsForUserForm();
                    } else if (targetSection === 'mail-section') {
                        loadUserEmailOptions();
                    } else if (targetSection === 'certificates-section') {
                        loadCertificates();
                    }
                });
            });
            
            // åˆå§‹åŒ–åŠ è½½æ•°æ®
            loadDashboardData();
            
            // è®¾ç½®è‡ªåŠ¨åˆ·æ–°
            setInterval(function() {
                if (document.getElementById('dashboard-section').style.display !== 'none') {
                    loadDashboardData();
                }
            }, 30000); // 30ç§’è‡ªåŠ¨åˆ·æ–°
            
            // æ¨¡æ€æ¡†äº‹ä»¶ç»‘å®š - ç¡®ä¿åœ¨DOMåŠ è½½å®Œæˆåç»‘å®š
            // ç”¨æˆ·æ¨¡æ€æ¡†äº‹ä»¶ç›‘å¬ - å½“æ¨¡æ€æ¡†æ˜¾ç¤ºæ—¶åŠ è½½åŸŸåé€‰é¡¹
            const addUserModal = document.getElementById('add-user-modal');
            if (addUserModal) {
                console.log('ç”¨æˆ·æ¨¡æ€æ¡†å…ƒç´ æ‰¾åˆ°ï¼Œç»‘å®šäº‹ä»¶...');
                addUserModal.addEventListener('show.bs.modal', function () {
                    console.log('ç”¨æˆ·æ¨¡æ€æ¡†æ˜¾ç¤ºäº‹ä»¶è§¦å‘ï¼Œå¼€å§‹åŠ è½½åŸŸåé€‰é¡¹');
                    loadDomainOptions();
                });
            } else {
                console.error('æœªæ‰¾åˆ°ç”¨æˆ·æ¨¡æ€æ¡†å…ƒç´ : add-user-modal');
            }
            
            // è¯ä¹¦æ¨¡æ€æ¡†äº‹ä»¶ç›‘å¬ - å½“æ¨¡æ€æ¡†æ˜¾ç¤ºæ—¶åŠ è½½åŸŸåé€‰é¡¹
            const issueCertModal = document.getElementById('issue-cert-modal');
            if (issueCertModal) {
                issueCertModal.addEventListener('show.bs.modal', function () {
                    loadCertDomainOptions();
                });
            }
            
            // å¼¹çª—åˆå§‹åŒ–æŒ‰é’®äº‹ä»¶ç›‘å¬
            const initSystemBtn = document.getElementById('init-system-btn');
            if (initSystemBtn) {
                initSystemBtn.addEventListener('click', function () {
                    initializeSystemFromModal();
                });
            }
            
            // ç”¨æˆ·åˆ›å»ºè¡¨å•æäº¤äº‹ä»¶
            const addUserForm = document.getElementById('add-user-form');
            if (addUserForm) {
                addUserForm.addEventListener('submit', async function (e) {
                    e.preventDefault();
                    await createUser();
                });
            }
            
            // é‚®ä»¶æ ‡ç­¾ç‚¹å‡»äº‹ä»¶ç›‘å¬ - å½“åˆ‡æ¢åˆ°å‘é€é‚®ä»¶æ ‡ç­¾æ—¶åŠ è½½é‚®ç®±é€‰é¡¹
            const sendMailTab = document.querySelector('a[href="#send-mail"]');
            if (sendMailTab) {
                sendMailTab.addEventListener('shown.bs.tab', function () {
                    console.log('å‘é€é‚®ä»¶æ ‡ç­¾è¢«æ¿€æ´»ï¼Œå¼€å§‹åŠ è½½é‚®ç®±é€‰é¡¹');
                    loadUserEmailOptions();
                });
            } else {
                console.error('æœªæ‰¾åˆ°å‘é€é‚®ä»¶æ ‡ç­¾');
            }
            
            // å½“é‚®ä»¶é¡µé¢è¢«æ¿€æ´»æ—¶ï¼Œç«‹å³åŠ è½½é‚®ç®±é€‰é¡¹
            const mailNavLink = document.querySelector('a[data-section="mail"]');
            if (mailNavLink) {
                mailNavLink.addEventListener('click', function() {
                    setTimeout(() => {
                        loadUserEmailOptions();
                    }, 100);
                });
            }
        });

        // åŠ è½½ä»ªè¡¨æ¿æ•°æ®
        function loadDashboardData() {
            // åŠ è½½å¥åº·çŠ¶æ€
            apiRequest('/api/v1/health')
                .then(response => response.json())
                .then(data => {
                    updateSystemStats(data);
                    updateServicesStatus(data.services || []);
                })
                .catch(error => {
                    console.error('Error loading health data:', error);
                    // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
                    document.getElementById('services-list').innerHTML = 
                        '<div class="col-12"><div class="alert alert-warning">æ— æ³•åŠ è½½æœåŠ¡çŠ¶æ€æ•°æ®</div></div>';
                });
        }

        // æ›´æ–°ç³»ç»Ÿç»Ÿè®¡
        function updateSystemStats(data) {
            if (data.system_info) {
                document.getElementById('cpu-usage').textContent = data.system_info.cpu_usage + '%';
                document.getElementById('memory-usage').textContent = data.system_info.memory_usage.toFixed(1) + '%';
                document.getElementById('disk-usage').textContent = data.system_info.disk_usage + '%';
                document.getElementById('uptime').textContent = data.system_info.uptime || 'N/A';
                document.getElementById('load-average').textContent = data.system_info.load_average || 'N/A';
                document.getElementById('system-load').textContent = data.system_info.cpu_usage + '%';
            }
            
            // æ›´æ–°ç»Ÿè®¡å¡ç‰‡
            document.getElementById('total-users').textContent = data.stats?.total_users || '0';
            document.getElementById('active-domains').textContent = data.stats?.active_domains || '0';
            document.getElementById('mail-queue').textContent = data.stats?.mail_queue || '0';
        }

        // æ›´æ–°æœåŠ¡çŠ¶æ€
        function updateServicesStatus(services) {
            const container = document.getElementById('services-list');
            container.innerHTML = '';
            
            if (!services || services.length === 0) {
                container.innerHTML = '<div class="col-12"><div class="alert alert-info">æš‚æ— æœåŠ¡çŠ¶æ€ä¿¡æ¯</div></div>';
                return;
            }
            
            services.forEach(service => {
                const statusClass = service.status === 'healthy' ? 'success' : 
                                  service.status === 'warning' ? 'warning' : 'danger';
                                  
                const serviceCard = document.createElement('div');
                serviceCard.className = 'col-md-6 mb-3';
                serviceCard.innerHTML = `
                    <div class="service-card ${service.status}">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">${service.name}</h6>
                                <small class="text-muted">${service.message || 'è¿è¡Œæ­£å¸¸'}</small>
                            </div>
                            <div>
                                <span class="status-indicator status-${service.status}"></span>
                                <span class="badge bg-${statusClass}">${service.status}</span>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(serviceCard);
            });
        }

        // ç³»ç»Ÿåˆå§‹åŒ–
        function initializeSystem() {
            const button = document.getElementById('init-system');
            const progress = document.getElementById('init-progress');
            const steps = document.getElementById('init-steps');
            
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> åˆå§‹åŒ–ä¸­...';
            progress.style.display = 'block';
            
            // æ¨¡æ‹Ÿåˆå§‹åŒ–æ•°æ®
            const initData = {
                domain: 'example.com',
                admin_email: 'admin@example.com',
                admin_password: 'admin123',
                smtp_host: 'localhost',
                smtp_port: 587
            };
            
            fetch('/api/v1/system/init', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(initData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.querySelector('.progress-bar').style.width = '100%';
                    steps.innerHTML = '<div class="alert alert-success"><i class="fas fa-check"></i> ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼</div>';
                    button.innerHTML = '<i class="fas fa-check"></i> åˆå§‹åŒ–å®Œæˆ';
                    setTimeout(() => {
                        // åˆå§‹åŒ–å®Œæˆååˆ·æ–°æ•´ä¸ªé¡µé¢ä»¥æ›´æ–°çŠ¶æ€
                        window.location.reload();
                    }, 2000);
                } else {
                    steps.innerHTML = '<div class="alert alert-danger"><i class="fas fa-times"></i> åˆå§‹åŒ–å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯') + '</div>';
                    button.innerHTML = '<i class="fas fa-play"></i> é‡è¯•åˆå§‹åŒ–';
                    button.disabled = false;
                }
            })
            .catch(error => {
                console.error('Init error:', error);
                steps.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle"></i> ç½‘ç»œè¿æ¥é”™è¯¯ï¼Œè¯·æ£€æŸ¥æœåŠ¡çŠ¶æ€</div>';
                button.innerHTML = '<i class="fas fa-times"></i> ç½‘ç»œé”™è¯¯';
                button.disabled = false;
            });
        }

        // åˆ·æ–°æŒ‰é’®
        document.getElementById('refresh-dashboard').addEventListener('click', function() {
            loadDashboardData();
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> åˆ·æ–°ä¸­...';
            setTimeout(() => {
                this.innerHTML = '<i class="fas fa-sync-alt"></i> åˆ·æ–°';
            }, 1000);
        });

        // åŸŸåç®¡ç†ç›¸å…³å‡½æ•°
        async function loadDomains() {
            const domainsListContainer = document.getElementById('domains-list');
            const emptyStateContainer = document.getElementById('domains-empty-state');
            
            try {
                const response = await apiRequest('/api/v1/domains');
                const domains = await response.json();
                
                if (domains && domains.length > 0) {
                    emptyStateContainer.style.display = 'none';
                    domainsListContainer.style.display = 'block';
                    
                    let html = '<div class="row">';
                    domains.forEach(domain => {
                        const statusBadge = domain.active ? 
                            '<span class="badge bg-success">æ´»è·ƒ</span>' : 
                            '<span class="badge bg-secondary">ç¦ç”¨</span>';
                            
                        html += `
                            <div class="col-md-6 col-lg-4 mb-3">
                                <div class="card h-100">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0">${domain.domain || domain.name}</h6>
                                        ${statusBadge}
                                    </div>
                                    <div class="card-body">
                                        <p class="text-muted small mb-2">çŠ¶æ€: ${domain.status || 'active'}</p>
                                        <p class="text-muted small mb-3">åˆ›å»ºæ—¶é—´: ${new Date(domain.created_at).toLocaleDateString()}</p>
                                        <div class="btn-group w-100" role="group">
                                            <button class="btn btn-outline-primary btn-sm" onclick="viewDNSRecords('${domain.domain || domain.name}')">
                                                <i class="fas fa-eye"></i> DNSè®°å½•
                                            </button>
                                            <button class="btn btn-outline-danger btn-sm" onclick="deleteDomain('${domain.domain || domain.name}')">
                                                <i class="fas fa-trash"></i> åˆ é™¤
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    domainsListContainer.innerHTML = html;
                } else {
                    domainsListContainer.style.display = 'none';
                    emptyStateContainer.style.display = 'block';
                }
            } catch (error) {
                console.error('åŠ è½½åŸŸåå¤±è´¥:', error);
                domainsListContainer.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i> 
                        åŠ è½½åŸŸååˆ—è¡¨å¤±è´¥ï¼š${error.message}
                        <button class="btn btn-outline-warning btn-sm ms-2" onclick="loadDomains()">é‡è¯•</button>
                    </div>
                `;
            }
        }

        // åˆ·æ–°åŸŸååˆ—è¡¨
        function refreshDomains() {
            loadDomains();
        }

        // æŸ¥çœ‹DNSè®°å½•
        async function viewDNSRecords(domain) {
            try {
                const response = await apiRequest(`/api/v1/domains/${domain}/dns`);
                const records = await response.json();
                
                let html = `
                    <div class="modal fade" id="dns-records-modal" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">DNSè®°å½• - ${domain}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle"></i>
                                        è¯·åœ¨æ‚¨çš„DNSæœåŠ¡å•†å¤„æ·»åŠ ä»¥ä¸‹è®°å½•ä»¥å¯ç”¨é‚®ä»¶æœåŠ¡
                                    </div>
                                    <div class="table-responsive">
                                        <table class="table table-bordered">
                                            <thead>
                                                <tr>
                                                    <th>ç±»å‹</th>
                                                    <th>åç§°</th>
                                                    <th>å€¼</th>
                                                    <th>TTL</th>
                                                    <th>çŠ¶æ€</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                `;
                
                records.forEach(record => {
                    const statusBadge = record.status === 'found' ? 
                        '<span class="badge bg-success">å·²é…ç½®</span>' : 
                        record.status === 'missing' ? 
                        '<span class="badge bg-warning">æœªé…ç½®</span>' : 
                        '<span class="badge bg-danger">é”™è¯¯</span>';
                        
                    html += `
                        <tr>
                            <td><code>${record.type}</code></td>
                            <td><code>${record.name}</code></td>
                            <td><code class="text-break">${record.value}</code></td>
                            <td>${record.ttl}</td>
                            <td>${statusBadge}</td>
                        </tr>
                    `;
                });
                
                html += `
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                                    <button type="button" class="btn btn-primary" onclick="recheckDNS('${domain}')">é‡æ–°æ£€æŸ¥</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // ç§»é™¤æ—§çš„æ¨¡æ€æ¡†
                const oldModal = document.getElementById('dns-records-modal');
                if (oldModal) {
                    oldModal.remove();
                }
                
                // æ·»åŠ æ–°çš„æ¨¡æ€æ¡†
                document.body.insertAdjacentHTML('beforeend', html);
                
                // æ˜¾ç¤ºæ¨¡æ€æ¡†
                const modal = new bootstrap.Modal(document.getElementById('dns-records-modal'));
                modal.show();
                
            } catch (error) {
                console.error('è·å–DNSè®°å½•å¤±è´¥:', error);
                alert('è·å–DNSè®°å½•å¤±è´¥: ' + error.message);
            }
        }

        // é‡æ–°æ£€æŸ¥DNS
        async function recheckDNS(domain) {
            try {
                // æ˜¾ç¤ºæ£€æŸ¥ä¸­æç¤º
                const modal = document.getElementById('dns-records-modal');
                const modalBody = modal.querySelector('.modal-body');
                const originalContent = modalBody.innerHTML;
                
                modalBody.innerHTML = `
                    <div class="text-center py-4">
                        <div class="loading-spinner mb-3"></div>
                        <h5>æ­£åœ¨æ£€æŸ¥DNSè®°å½•...</h5>
                        <p class="text-muted">è¿™å¯èƒ½éœ€è¦å‡ ç§’é’Ÿæ—¶é—´</p>
                    </div>
                `;
                
                const response = await apiRequest(`/api/v1/domains/${domain}/dns/check`, {
                    method: 'POST'
                });
                const result = await response.json();
                
                if (response.ok) {
                    // æ›´æ–°æ¨¡æ€æ¡†å†…å®¹æ˜¾ç¤ºæ£€æŸ¥ç»“æœ
                    let html = `
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            DNSè®°å½•æ£€æŸ¥å®Œæˆ - ${new Date().toLocaleString()}
                        </div>
                        <div class="table-responsive">
                            <table class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th>ç±»å‹</th>
                                        <th>åç§°</th>
                                        <th>å€¼</th>
                                        <th>TTL</th>
                                        <th>çŠ¶æ€</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    result.records.forEach(record => {
                        const statusBadge = record.status === 'found' ? 
                            '<span class="badge bg-success">å·²é…ç½®</span>' : 
                            record.status === 'missing' ? 
                            '<span class="badge bg-warning">æœªé…ç½®</span>' : 
                            '<span class="badge bg-danger">é”™è¯¯</span>';
                            
                        html += `
                            <tr>
                                <td><code>${record.type}</code></td>
                                <td><code>${record.name}</code></td>
                                <td><code class="text-break">${record.value}</code></td>
                                <td>${record.ttl || 300}</td>
                                <td>${statusBadge}</td>
                            </tr>
                        `;
                    });
                    
                    html += `
                                    </tbody>
                                </table>
                            </div>
                    `;
                    
                    modalBody.innerHTML = html;
                    
                    // æ˜¾ç¤ºæˆåŠŸæç¤º
                    const alertHtml = `
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            <i class="fas fa-check-circle"></i> DNSè®°å½•æ£€æŸ¥å®Œæˆï¼
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    `;
                    modalBody.insertAdjacentHTML('afterbegin', alertHtml);
                    
                } else {
                    modalBody.innerHTML = originalContent;
                    alert('DNSæ£€æŸ¥å¤±è´¥: ' + result.error);
                }
            } catch (error) {
                console.error('DNSæ£€æŸ¥å¤±è´¥:', error);
                alert('DNSæ£€æŸ¥å¤±è´¥: ' + error.message);
            }
        }

        // ä»å¼¹çª—æ‰§è¡Œç³»ç»Ÿåˆå§‹åŒ–
        function initializeSystemFromModal() {
            const button = document.getElementById('init-system-btn');
            const modal = document.getElementById('system-init-modal');
            const progressContainer = modal.querySelector('#init-progress');
            const stepsContainer = modal.querySelector('#init-steps');
            const progressBar = modal.querySelector('.progress-bar');
            const progressText = modal.querySelector('.progress-text');
            
            // ç¦ç”¨æŒ‰é’®å¹¶æ˜¾ç¤ºè¿›åº¦
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>åˆå§‹åŒ–ä¸­...';
            
            if (progressContainer) {
                progressContainer.classList.remove('d-none');
            }
            
            // æ¨¡æ‹Ÿè¿›åº¦æ›´æ–°
            const updateProgress = (value, message) => {
                if (progressBar) {
                    progressBar.style.width = value + '%';
                    progressBar.setAttribute('aria-valuenow', value);
                }
                if (progressText) {
                    progressText.textContent = value + '%';
                }
                if (stepsContainer && message) {
                    stepsContainer.innerHTML = `
                        <div class="d-flex align-items-center text-primary">
                            <i class="fas fa-cog fa-spin me-2"></i>
                            <span>${message}</span>
                        </div>
                    `;
                }
            };
            
            // æ¨¡æ‹Ÿåˆå§‹åŒ–æ­¥éª¤
            updateProgress(10, 'æ­£åœ¨æ£€æŸ¥ç³»ç»Ÿç¯å¢ƒ...');
            
            setTimeout(() => {
                updateProgress(30, 'æ­£åœ¨å®‰è£…é‚®ä»¶æœåŠ¡ç»„ä»¶...');
            }, 1000);
            
            setTimeout(() => {
                updateProgress(60, 'æ­£åœ¨é…ç½®å®‰å…¨å·¥å…·...');
            }, 2000);
            
            setTimeout(() => {
                updateProgress(90, 'æ­£åœ¨å®Œæˆæœ€ç»ˆé…ç½®...');
            }, 3000);
            
            // è°ƒç”¨ç³»ç»Ÿåˆå§‹åŒ–API
            setTimeout(() => {
                fetch('/api/v1/system/init', {
                    method: 'POST',
                    headers: getAuthHeaders()
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateProgress(100, '');
                        if (stepsContainer) {
                            stepsContainer.innerHTML = `
                                <div class="alert alert-success border-0 mb-0">
                                    <i class="fas fa-check-circle me-2"></i>
                                    <strong>ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼</strong><br>
                                    <small class="text-muted">æ‰€æœ‰é‚®ä»¶æœåŠ¡å·²æˆåŠŸå®‰è£…å¹¶é…ç½®ã€‚</small>
                                </div>
                            `;
                        }
                        button.innerHTML = '<i class="fas fa-check me-2"></i>åˆå§‹åŒ–å®Œæˆ';
                        
                        setTimeout(() => {
                            // å…³é—­å¼¹çª—
                            const modalInstance = bootstrap.Modal.getInstance(modal);
                            if (modalInstance) {
                                modalInstance.hide();
                            }
                            // åˆ·æ–°é¡µé¢ä»¥æ›´æ–°çŠ¶æ€
                            window.location.reload();
                        }, 2000);
                    } else {
                        if (stepsContainer) {
                            stepsContainer.innerHTML = `
                                <div class="alert alert-danger border-0 mb-0">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    <strong>åˆå§‹åŒ–å¤±è´¥</strong><br>
                                    <small>${data.message || 'æœªçŸ¥é”™è¯¯'}</small>
                                </div>
                            `;
                        }
                        button.disabled = false;
                        button.innerHTML = '<i class="fas fa-redo me-2"></i>é‡è¯•';
                    }
                })
                .catch(error => {
                    console.error('Modal init error:', error);
                    if (stepsContainer) {
                        stepsContainer.innerHTML = `
                            <div class="alert alert-danger border-0 mb-0">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <strong>ç½‘ç»œé”™è¯¯</strong><br>
                                <small>è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•</small>
                            </div>
                        `;
                    }
                    button.disabled = false;
                    button.innerHTML = '<i class="fas fa-redo me-2"></i>é‡è¯•';
                });
            }, 4000);
        }

        // é‚®ä»¶ç®¡ç†ç›¸å…³å‡½æ•°
        async function loadUserEmailOptions() {
            console.log('å¼€å§‹åŠ è½½é‚®ç®±é€‰é¡¹...');
            try {
                // è·å–ç”¨æˆ·åˆ—è¡¨
                const response = await apiRequest('/api/v1/users');
                console.log('ç”¨æˆ·APIå“åº”çŠ¶æ€:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const users = await response.json();
                console.log('è·å–åˆ°çš„ç”¨æˆ·æ•°æ®:', users);
                
                const fromSelect = document.getElementById('mail-from');
                if (!fromSelect) {
                    console.error('æœªæ‰¾åˆ°mail-fromé€‰æ‹©æ¡†');
                    return;
                }
                
                fromSelect.innerHTML = '<option value="">é€‰æ‹©å‘ä»¶äººé‚®ç®±</option>';
                
                if (users && users.length > 0) {
                    console.log(`æ­£åœ¨æ·»åŠ  ${users.length} ä¸ªé‚®ç®±é€‰é¡¹`);
                    users.forEach(user => {
                        if (user.email) {
                            const option = document.createElement('option');
                            option.value = user.email;
                            option.textContent = `${user.name || user.email} <${user.email}>`;
                            fromSelect.appendChild(option);
                            console.log('å·²æ·»åŠ é‚®ç®±é€‰é¡¹:', user.email);
                        }
                    });
                    console.log('é‚®ç®±é€‰é¡¹åŠ è½½å®Œæˆ');
                } else {
                    console.log('ç”¨æˆ·åˆ—è¡¨ä¸ºç©ºï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯');
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'æš‚æ— å¯ç”¨é‚®ç®±ç”¨æˆ·ï¼Œè¯·å…ˆåˆ›å»ºç”¨æˆ·';
                    option.disabled = true;
                    fromSelect.appendChild(option);
                }
            } catch (error) {
                console.error('åŠ è½½é‚®ç®±é€‰é¡¹å¤±è´¥:', error);
                const fromSelect = document.getElementById('mail-from');
                if (fromSelect) {
                    fromSelect.innerHTML = '<option value="">åŠ è½½é‚®ç®±å¤±è´¥</option>';
                }
            }
        }

        // ç”¨æˆ·ç®¡ç†ç›¸å…³å‡½æ•°
        async function loadUsers() {
            console.log('å¼€å§‹åŠ è½½ç”¨æˆ·åˆ—è¡¨...');
            const usersListContainer = document.getElementById('users-list');
            const emptyStateContainer = document.getElementById('users-empty-state');
            
            if (!usersListContainer) {
                console.error('æœªæ‰¾åˆ°ç”¨æˆ·åˆ—è¡¨å®¹å™¨');
                return;
            }
            
            try {
                const response = await apiRequest('/api/v1/users');
                console.log('ç”¨æˆ·APIå“åº”çŠ¶æ€:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const users = await response.json();
                console.log('è·å–åˆ°çš„ç”¨æˆ·æ•°æ®:', users);
                
                if (users && users.length > 0) {
                    if (emptyStateContainer) emptyStateContainer.style.display = 'none';
                    usersListContainer.style.display = 'block';
                    
                    let html = '<div class="table-responsive"><table class="table table-striped"><thead><tr>';
                    html += '<th>é‚®ç®±</th><th>å§“å</th><th>åŸŸå</th><th>çŠ¶æ€</th><th>é…é¢</th><th>åˆ›å»ºæ—¶é—´</th><th>æ“ä½œ</th>';
                    html += '</tr></thead><tbody>';
                    
                    users.forEach(user => {
                        const statusBadge = user.active ? 
                            '<span class="badge bg-success">æ´»è·ƒ</span>' : 
                            '<span class="badge bg-secondary">ç¦ç”¨</span>';
                        
                        const quota = user.quota ? `${(user.quota/1024/1024).toFixed(0)}MB` : 'æ— é™åˆ¶';
                        const createdAt = new Date(user.created_at).toLocaleDateString();
                        
                        html += `
                            <tr>
                                <td>${user.email}</td>
                                <td>${user.name}</td>
                                <td>${user.domain}</td>
                                <td>${statusBadge}</td>
                                <td>${quota}</td>
                                <td>${createdAt}</td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-warning" onclick="editUser('${user.id}')">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-outline-info" onclick="resetUserPassword('${user.id}')">
                                            <i class="fas fa-key"></i>
                                        </button>
                                        <button class="btn btn-outline-danger" onclick="deleteUser('${user.id}')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    });
                    
                    html += '</tbody></table></div>';
                    usersListContainer.innerHTML = html;
                } else {
                    usersListContainer.style.display = 'none';
                    if (emptyStateContainer) emptyStateContainer.style.display = 'block';
                }
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥:', error);
                usersListContainer.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i> 
                        åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥ï¼š${error.message}
                        <button class="btn btn-outline-warning btn-sm ms-2" onclick="loadUsers()">é‡è¯•</button>
                    </div>
                `;
            }
        }

        // åˆ›å»ºç”¨æˆ·
        async function createUser() {
            const form = document.getElementById('add-user-form');
            const formData = new FormData(form);
            
            const emailLocal = formData.get('email_local');
            const domain = formData.get('domain');
            const name = formData.get('name');
            const password = formData.get('password');
            const quota = parseInt(formData.get('quota')) * 1024 * 1024; // è½¬æ¢ä¸ºå­—èŠ‚
            const active = formData.has('active');
            
            if (!emailLocal || !domain || !name || !password) {
                alert('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ');
                return;
            }
            
            const email = `${emailLocal}@${domain}`;
            
            try {
                const response = await apiRequest('/api/v1/users', {
                    method: 'POST',
                    body: JSON.stringify({
                        email: email,
                        name: name,
                        password: password,
                        quota: quota,
                        active: active
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('ç”¨æˆ·åˆ›å»ºæˆåŠŸ:', result);
                    showAlert('ç”¨æˆ·åˆ›å»ºæˆåŠŸï¼', 'æ“ä½œæˆåŠŸ', 'success');
                    
                    // å…³é—­æ¨¡æ€æ¡†
                    const modal = bootstrap.Modal.getInstance(document.getElementById('add-user-modal'));
                    if (modal) {
                        modal.hide();
                    }
                    
                    // é‡ç½®è¡¨å•
                    form.reset();
                    
                    // åˆ·æ–°ç”¨æˆ·åˆ—è¡¨
                    loadUsers();
                } else {
                    const error = await response.json();
                    showAlert('ç”¨æˆ·åˆ›å»ºå¤±è´¥: ' + (error.error || 'æœªçŸ¥é”™è¯¯'), 'æ“ä½œå¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('åˆ›å»ºç”¨æˆ·å¤±è´¥:', error);
                showAlert('åˆ›å»ºç”¨æˆ·å¤±è´¥: ' + error.message, 'ç½‘ç»œé”™è¯¯', 'error');
            }
        }

        // åˆ·æ–°ç”¨æˆ·åˆ—è¡¨
        function refreshUsers() {
            loadUsers();
        }

        // ç¼–è¾‘ç”¨æˆ·ï¼ˆæš‚æ—¶åªæ˜¾ç¤ºæç¤ºï¼‰
        function editUser(userId) {
            alert('ç¼–è¾‘ç”¨æˆ·åŠŸèƒ½å°†åœ¨åç»­ç‰ˆæœ¬ä¸­å®ç°');
        }

        // é‡ç½®ç”¨æˆ·å¯†ç 
        async function resetUserPassword(userId) {
            if (!confirm('ç¡®å®šè¦é‡ç½®è¯¥ç”¨æˆ·çš„å¯†ç å—ï¼Ÿ')) {
                return;
            }
            
            try {
                const response = await apiRequest(`/api/v1/users/${userId}/reset-password`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert(`å¯†ç é‡ç½®æˆåŠŸï¼æ–°å¯†ç ï¼š${result.new_password}`);
                } else {
                    const error = await response.json();
                    alert('å¯†ç é‡ç½®å¤±è´¥: ' + (error.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('é‡ç½®å¯†ç å¤±è´¥:', error);
                alert('é‡ç½®å¯†ç å¤±è´¥: ' + error.message);
            }
        }

        // åˆ é™¤ç”¨æˆ·
        async function deleteUser(userId) {
            if (!(await showConfirm('ç¡®å®šè¦åˆ é™¤è¯¥ç”¨æˆ·å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚', 'åˆ é™¤ç”¨æˆ·ç¡®è®¤', { dangerConfirm: true }))) {
                return;
            }
            
            try {
                const response = await apiRequest(`/api/v1/users/${userId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showAlert('ç”¨æˆ·åˆ é™¤æˆåŠŸ', 'æ“ä½œæˆåŠŸ', 'success');
                    loadUsers(); // åˆ·æ–°åˆ—è¡¨
                } else {
                    const error = await response.json();
                    alert('åˆ é™¤ç”¨æˆ·å¤±è´¥: ' + (error.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('åˆ é™¤ç”¨æˆ·å¤±è´¥:', error);
                alert('åˆ é™¤ç”¨æˆ·å¤±è´¥: ' + error.message);
            }
        }

        // åŠ è½½åŸŸåé€‰é¡¹åˆ°ç”¨æˆ·è¡¨å•
        async function loadDomainOptions() {
            console.log('å¼€å§‹åŠ è½½åŸŸåé€‰é¡¹...');
            try {
                const response = await apiRequest('/api/v1/domains');
                console.log('åŸŸåAPIå“åº”çŠ¶æ€:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const domains = await response.json();
                console.log('è·å–åˆ°çš„åŸŸåæ•°æ®:', domains);
                
                const domainSelect = document.getElementById('user-domain');
                if (!domainSelect) {
                    console.error('æœªæ‰¾åˆ°user-domainé€‰æ‹©æ¡†');
                    return;
                }
                
                domainSelect.innerHTML = '<option value="">é€‰æ‹©åŸŸå</option>';
                
                if (domains && domains.length > 0) {
                    console.log(`æ­£åœ¨æ·»åŠ  ${domains.length} ä¸ªåŸŸåé€‰é¡¹`);
                    domains.forEach(domain => {
                        const domainName = domain.domain || domain.name;
                        if (domainName) {
                            const option = document.createElement('option');
                            option.value = domainName;
                            option.textContent = domainName;
                            domainSelect.appendChild(option);
                            console.log('å·²æ·»åŠ åŸŸåé€‰é¡¹:', domainName);
                        }
                    });
                } else {
                    console.log('æ²¡æœ‰æ‰¾åˆ°å¯ç”¨åŸŸå');
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'æš‚æ— å¯ç”¨åŸŸåï¼Œè¯·å…ˆæ·»åŠ åŸŸå';
                    option.disabled = true;
                    domainSelect.appendChild(option);
                }
            } catch (error) {
                console.error('åŠ è½½åŸŸåé€‰é¡¹å¤±è´¥:', error);
                const domainSelect = document.getElementById('user-domain');
                if (domainSelect) {
                    domainSelect.innerHTML = `<option value="">åŠ è½½åŸŸåå¤±è´¥: ${error.message}</option>`;
                }
            }
        }

        // åˆ é™¤åŸŸå
        async function deleteDomain(domain) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤åŸŸå ${domain} å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`)) {
                return;
            }

            try {
                const response = await apiRequest(`/api/v1/domains/${domain}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    alert('åŸŸååˆ é™¤æˆåŠŸ');
                    loadDomains(); // é‡æ–°åŠ è½½åŸŸååˆ—è¡¨
                } else {
                    const error = await response.json();
                    alert('åˆ é™¤å¤±è´¥: ' + error.error);
                }
            } catch (error) {
                console.error('åˆ é™¤åŸŸåå¤±è´¥:', error);
                alert('åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }
        
        // è¯ä¹¦ç®¡ç†ç›¸å…³å‡½æ•°
        async function loadCertificates() {
            const certificatesListContainer = document.getElementById('certificates-list');
            const emptyStateContainer = document.getElementById('certificates-empty-state');
            
            try {
                const response = await apiRequest('/api/v1/certificates');
                const certificates = await response.json();
                
                if (certificates && certificates.length > 0) {
                    emptyStateContainer.style.display = 'none';
                    certificatesListContainer.style.display = 'block';
                    
                    let html = '<div class="row">';
                    certificates.forEach(cert => {
                        const statusBadge = cert.status === 'valid' ? 
                            '<span class="badge bg-success">æœ‰æ•ˆ</span>' : 
                            cert.status === 'expired' ?
                            '<span class="badge bg-danger">å·²è¿‡æœŸ</span>' :
                            '<span class="badge bg-warning">å³å°†è¿‡æœŸ</span>';
                        
                        const expiryDate = cert.expires_at ? 
                            new Date(cert.expires_at).toLocaleDateString() : 
                            'æœªçŸ¥';
                            
                        html += `
                            <div class="col-md-6 col-lg-4 mb-3">
                                <div class="card h-100">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0">${cert.domain}</h6>
                                        ${statusBadge}
                                    </div>
                                    <div class="card-body">
                                        <p class="text-muted small mb-2">ç±»å‹: ${cert.type || 'SSL'}</p>
                                        <p class="text-muted small mb-2">åˆ°æœŸæ—¶é—´: ${expiryDate}</p>
                                        <p class="text-muted small mb-3">ç­¾å‘å•†: ${cert.issuer || 'Let\'s Encrypt'}</p>
                                        <div class="btn-group w-100" role="group">
                                            <button class="btn btn-outline-primary btn-sm" onclick="renewCertificate('${cert.domain}')">
                                                <i class="fas fa-sync-alt"></i> ç»­æœŸ
                                            </button>
                                            <button class="btn btn-outline-danger btn-sm" onclick="deleteCertificate('${cert.domain}')">
                                                <i class="fas fa-trash"></i> åˆ é™¤
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    certificatesListContainer.innerHTML = html;
                } else {
                    certificatesListContainer.style.display = 'none';
                    emptyStateContainer.style.display = 'block';
                }
            } catch (error) {
                console.error('åŠ è½½è¯ä¹¦å¤±è´¥:', error);
                certificatesListContainer.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i> 
                        åŠ è½½è¯ä¹¦åˆ—è¡¨å¤±è´¥ï¼š${error.message}
                        <button class="btn btn-outline-warning btn-sm ms-2" onclick="loadCertificates()">é‡è¯•</button>
                    </div>
                `;
            }
        }

        // åˆ·æ–°è¯ä¹¦åˆ—è¡¨
        function refreshCertificates() {
            loadCertificates();
        }

        // ç»­æœŸè¯ä¹¦
        async function renewCertificate(domain) {
            if (!confirm(`ç¡®å®šè¦ä¸ºåŸŸå ${domain} ç»­æœŸè¯ä¹¦å—ï¼Ÿ`)) {
                return;
            }

            try {
                const response = await apiRequest('/api/v1/certificates/renew', {
                    method: 'POST',
                    body: JSON.stringify({ domain: domain })
                });

                if (response.ok) {
                    alert('è¯ä¹¦ç»­æœŸæˆåŠŸ');
                    loadCertificates();
                } else {
                    const error = await response.json();
                    alert('ç»­æœŸå¤±è´¥: ' + error.error);
                }
            } catch (error) {
                console.error('ç»­æœŸè¯ä¹¦å¤±è´¥:', error);
                alert('ç»­æœŸå¤±è´¥: ' + error.message);
            }
        }

        // åˆ é™¤è¯ä¹¦ï¼ˆå¸¦UIç¡®è®¤ï¼Œå¯å¤åˆ¶ä¿¡æ¯ï¼‰
        async function deleteCertificate(domain) {
            const html = `
                <div class="mb-2">è¯·ç¡®è®¤è¦åˆ é™¤ä»¥ä¸‹åŸŸåçš„è¯ä¹¦ï¼š</div>
                <pre class="bg-light p-2 border rounded small">${domain}</pre>
                <div class="text-danger small">åˆ é™¤åå°†å›é€€ä¸ºç³»ç»Ÿé»˜è®¤è¯ä¹¦ï¼ˆsnakeoilï¼‰ï¼Œè¯·å°½å¿«é‡æ–°ç­¾å‘æ­£å¼è¯ä¹¦ã€‚</div>
            `;
            const ok = await showConfirm(html, 'åˆ é™¤è¯ä¹¦ç¡®è®¤', { dangerConfirm: true, html: true });
            if (!ok) return;

            try {
                const resp = await apiRequest(`/api/v1/certificates/${encodeURIComponent(domain)}`, { method: 'DELETE' });
                if (resp.ok) {
                    showAlert('è¯ä¹¦å·²åˆ é™¤ï¼ŒæœåŠ¡å°†ä½¿ç”¨é»˜è®¤è¯ä¹¦è¿è¡Œã€‚', 'æ“ä½œæˆåŠŸ', 'success');
                    refreshCertificates();
                } else {
                    const err = await resp.json().catch(() => ({}));
                    showAlert('åˆ é™¤è¯ä¹¦å¤±è´¥: ' + (err.error || resp.statusText), 'æ“ä½œå¤±è´¥', 'error');
                }
            } catch (e) {
                console.error('åˆ é™¤è¯ä¹¦å¤±è´¥: ', e);
                showAlert('åˆ é™¤è¯ä¹¦å¤±è´¥: ' + e.message, 'ç½‘ç»œé”™è¯¯', 'error');
            }
        }

        // åŠ è½½åŸŸåé€‰é¡¹åˆ°è¯ä¹¦è¡¨å•
        async function loadCertDomainOptions() {
            try {
                const response = await apiRequest('/api/v1/domains');
                const domains = await response.json();
                
                const domainSelect = document.getElementById('cert-domain');
                domainSelect.innerHTML = '<option value="">é€‰æ‹©è¦ç­¾å‘è¯ä¹¦çš„åŸŸå</option>';
                
                if (domains && domains.length > 0) {
                    domains.forEach(domain => {
                        const option = document.createElement('option');
                        option.value = domain.domain || domain.name;
                        option.textContent = domain.domain || domain.name;
                        domainSelect.appendChild(option);
                    });
                } else {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'æš‚æ— å¯ç”¨åŸŸåï¼Œè¯·å…ˆæ·»åŠ åŸŸå';
                    option.disabled = true;
                    domainSelect.appendChild(option);
                }
            } catch (error) {
                console.error('åŠ è½½è¯ä¹¦åŸŸåé€‰é¡¹å¤±è´¥:', error);
                const domainSelect = document.getElementById('cert-domain');
                domainSelect.innerHTML = '<option value="">åŠ è½½åŸŸåå¤±è´¥</option>';
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // å…¶ä»–åˆå§‹åŒ–ä»£ç ...
        });
        
    </script>

    <!-- æ·»åŠ åŸŸåæ¨¡æ€æ¡† -->
    <div class="modal fade" id="add-domain-modal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">æ·»åŠ åŸŸå</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-8">
                            <form id="add-domain-form">
                                <div class="mb-3">
                                    <label for="domain-name" class="form-label">åŸŸå</label>
                                    <input type="text" class="form-control" id="domain-name" name="domain" required placeholder="example.com">
                                    <div class="form-text">è¯·è¾“å…¥å®Œæ•´çš„åŸŸåï¼Œå¦‚ï¼šexample.com</div>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="domain-active" name="active" checked>
                                    <label class="form-check-label" for="domain-active">å¯ç”¨åŸŸå</label>
                                </div>
                            </form>
                        </div>
                        <div class="col-md-4">
                            <div class="card h-100">
                                <div class="card-header"><i class="fas fa-info-circle"></i> æç¤º</div>
                                <div class="card-body">
                                    <ul class="list-unstyled small">
                                        <li>å»ºè®®ä½¿ç”¨ä½ çš„ä¸šåŠ¡ä¸»åŸŸå</li>
                                        <li>åˆ›å»ºåå¯ç«‹å³ç”³è¯·è¯ä¹¦ä¸æ·»åŠ ç”¨æˆ·</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="submit" form="add-domain-form" class="btn btn-primary" id="add-domain-submit">æ·»åŠ åŸŸå</button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ ç”¨æˆ·æ¨¡æ€æ¡† -->
    <div class="modal fade" id="add-user-modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">æ·»åŠ ç”¨æˆ·</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="add-user-form">
                        <div class="row">
                            <div class="col-md-8">
                                <label for="user-email-local" class="form-label">é‚®ç®±åœ°å€</label>
                                <input type="text" class="form-control" id="user-email-local" name="email_local" required placeholder="ç”¨æˆ·å">
                            </div>
                            <div class="col-md-4">
                                <label for="user-domain" class="form-label">åŸŸå</label>
                                <select class="form-select" id="user-domain" name="domain" required>
                                    <option value="">é€‰æ‹©åŸŸå</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="user-name" class="form-label">å§“å</label>
                            <input type="text" class="form-control" id="user-name" name="name" required placeholder="ç”¨æˆ·å§“å">
                        </div>
                        <div class="mb-3">
                            <label for="user-password" class="form-label">å¯†ç </label>
                            <input type="password" class="form-control" id="user-password" name="password" required placeholder="è‡³å°‘8ä¸ªå­—ç¬¦">
                        </div>
                        <div class="mb-3">
                            <label for="user-quota" class="form-label">é‚®ç®±é…é¢ (MB)</label>
                            <input type="number" class="form-control" id="user-quota" name="quota" value="1024" min="1">
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="user-active" name="active" checked>
                            <label class="form-check-label" for="user-active">å¯ç”¨ç”¨æˆ·</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="submit" form="add-user-form" class="btn btn-primary">åˆ›å»ºç”¨æˆ·</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ç­¾å‘è¯ä¹¦æ¨¡æ€æ¡† -->
    <div class="modal fade" id="issue-cert-modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ç­¾å‘SSLè¯ä¹¦</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="issue-cert-form">
                        <div class="mb-3">
                            <label for="cert-email" class="form-label">Let's Encrypt è´¦æˆ·é‚®ç®± <span class="text-danger">*</span></label>
                            <input type="email" class="form-control" id="cert-email" name="email" required
                                   placeholder="ç”¨äºæ¥æ”¶è¯ä¹¦åˆ°æœŸé€šçŸ¥å’Œé‡è¦é€šçŸ¥">
                            <div class="form-text">
                                <i class="fas fa-info-circle text-primary"></i>
                                æ­¤é‚®ç®±å°†ç”¨äºæ³¨å†ŒLet's Encryptè´¦æˆ·ï¼Œæ¥æ”¶è¯ä¹¦ç›¸å…³é€šçŸ¥ã€‚è¯·ç¡®ä¿é‚®ç®±æœ‰æ•ˆä¸”å¯ä»¥æ­£å¸¸æ¥æ”¶é‚®ä»¶ã€‚
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="cert-domain" class="form-label">åŸŸå</label>
                            <select class="form-select" id="cert-domain" name="domain" required>
                                <option value="">é€‰æ‹©è¦ç­¾å‘è¯ä¹¦çš„åŸŸå</option>
                            </select>
                            <div class="form-text">è¯·é€‰æ‹©å·²é…ç½®DNSè®°å½•çš„åŸŸå</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">è¯ä¹¦ç±»å‹</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="cert_type" id="cert-mail" value="mail" checked>
                                <label class="form-check-label" for="cert-mail">
                                    <strong>é‚®ä»¶æœåŠ¡å™¨è¯ä¹¦ (mail.domain.com)</strong>
                                </label>
                                <div class="form-text text-success">æ¨èï¼šä¸“ç”¨äºé‚®ä»¶æœåŠ¡å™¨çš„æ ‡å‡†è¯ä¹¦</div>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="cert_type" id="cert-wildcard" value="wildcard">
                                <label class="form-check-label" for="cert-wildcard">
                                    <strong>é€šé…ç¬¦è¯ä¹¦ (*.domain.com)</strong>
                                </label>
                                <div class="form-text text-info">è¦†ç›–æ‰€æœ‰å­åŸŸåï¼Œä»…æ”¯æŒDNSéªŒè¯</div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="cert-email" class="form-label">é‚®ç®±åœ°å€</label>
                            <input type="email" class="form-control" id="cert-email" name="email" required
                                   placeholder="admin@domain.com">
                            <div class="form-text">ç”¨äºLet's Encrypté€šçŸ¥å’Œè¯ä¹¦åˆ°æœŸæé†’</div>
                        </div>
                        <div class="alert alert-info">
                            <h6><i class="fas fa-info-circle"></i> DNSéªŒè¯è¯´æ˜</h6>
                            <ul class="mb-0">
                                <li>ç³»ç»Ÿä¼šç”ŸæˆDNS TXTè®°å½•éªŒè¯å€¼</li>
                                <li>æ‚¨éœ€è¦æ‰‹åŠ¨æ·»åŠ TXTè®°å½•åˆ°åŸŸåDNS</li>
                                <li>éªŒè¯å®Œæˆåç³»ç»Ÿä¼šè‡ªåŠ¨ç­¾å‘è¯ä¹¦</li>
                                <li>é€‚ç”¨äºæ‰€æœ‰ç±»å‹çš„è¯ä¹¦ç”³è¯·</li>
                            </ul>
                        </div>
                    </form>
                    
                    <!-- DNSéªŒè¯æ­¥éª¤æ˜¾ç¤ºåŒºåŸŸ -->
                    <div id="dns-validation-section" class="d-none mt-4">
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>DNSéªŒè¯æ‰€éœ€</strong><br>
                            è¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ·»åŠ DNS TXTè®°å½•æ¥éªŒè¯åŸŸåæ‰€æœ‰æƒï¼š
                        </div>
                        
                        <div class="card">
                            <div class="card-header bg-light">
                                <h6 class="mb-0"><i class="fas fa-dns me-2"></i>DNSè®°å½•ä¿¡æ¯</h6>
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-sm-3"><strong>è®°å½•ç±»å‹ï¼š</strong></div>
                                    <div class="col-sm-9">
                                        <code class="bg-light p-1">TXT</code>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-sm-3"><strong>è®°å½•åç§°ï¼š</strong></div>
                                    <div class="col-sm-9">
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="dns-record-name" readonly>
                                            <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard('dns-record-name')" title="å¤åˆ¶">
                                                <i class="fas fa-copy"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-sm-3"><strong>è®°å½•å€¼ï¼š</strong></div>
                                    <div class="col-sm-9">
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="dns-record-value" readonly>
                                            <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard('dns-record-value')" title="å¤åˆ¶">
                                                <i class="fas fa-copy"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="alert alert-info mt-3">
                            <h6><i class="fas fa-info-circle me-2"></i>æ“ä½œè¯´æ˜</h6>
                            <ol class="mb-0">
                                <li>å¤åˆ¶ä¸Šè¿°DNSè®°å½•ä¿¡æ¯</li>
                                <li>ç™»å½•æ‚¨çš„åŸŸåDNSç®¡ç†ç•Œé¢</li>
                                <li>æ·»åŠ TXTè®°å½•åˆ°DNSè§£æè®¾ç½®</li>
                                <li>ç­‰å¾…DNSè®°å½•ç”Ÿæ•ˆï¼ˆé€šå¸¸5-10åˆ†é’Ÿï¼‰</li>
                                <li>ç‚¹å‡»"ç»§ç»­éªŒè¯"æŒ‰é’®å®ŒæˆéªŒè¯</li>
                            </ol>
                        </div>
                        
                        <div id="dns-validation-result" class="mt-3"></div>
                    </div>

                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="submit" form="issue-cert-form" class="btn btn-primary" id="issue-cert-submit">
                        <i class="fas fa-certificate me-2"></i>å¼€å§‹ç”³è¯·
                    </button>
                    <button type="button" class="btn btn-success d-none" id="continue-validation-btn" onclick="continueValidation()">
                        <i class="fas fa-check me-2"></i>å®ŒæˆDNSéªŒè¯
                    </button>
                    <button type="button" class="btn btn-outline-primary d-none" id="back-to-form-btn" onclick="backToForm()">
                        <i class="fas fa-arrow-left me-2"></i>è¿”å›è¡¨å•
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ç³»ç»Ÿåˆå§‹åŒ–æ¨¡æ€æ¡† -->
    <div class="modal fade" id="system-init-modal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-cogs me-2"></i>ç³»ç»Ÿåˆå§‹åŒ–
                    </h5>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info d-flex align-items-center">
                        <i class="fas fa-info-circle me-3 fs-4"></i>
                        <div>
                            <strong>é¦–æ¬¡ä½¿ç”¨æ£€æµ‹</strong><br>
                            æ£€æµ‹åˆ°ç³»ç»Ÿå°šæœªå®Œæˆåˆå§‹åŒ–ï¼Œéœ€è¦å®‰è£…å’Œé…ç½®å¿…è¦çš„é‚®ä»¶æœåŠ¡ç»„ä»¶ã€‚
                        </div>
                    </div>
                    
                    <h6 class="text-primary mb-3">
                        <i class="fas fa-download me-2"></i>ç³»ç»Ÿå°†å®‰è£…ä»¥ä¸‹ç»„ä»¶ï¼š
                    </h6>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="card h-100 border-success">
                                <div class="card-header bg-light">
                                    <small class="fw-bold text-success">é‚®ä»¶æœåŠ¡</small>
                                </div>
                                <div class="card-body py-2">
                                    <ul class="list-unstyled mb-0 small">
                                        <li class="mb-1"><i class="fas fa-check-circle text-success me-2"></i>Postfix (SMTPæœåŠ¡å™¨)</li>
                                        <li class="mb-1"><i class="fas fa-check-circle text-success me-2"></i>Dovecot (IMAP/POP3æœåŠ¡å™¨)</li>
                                        <li class="mb-1"><i class="fas fa-check-circle text-success me-2"></i>Rspamd (ååƒåœ¾é‚®ä»¶)</li>
                                        <li class="mb-1"><i class="fas fa-check-circle text-success me-2"></i>OpenDKIM (é‚®ä»¶è®¤è¯)</li>
                                        <li class="mb-0"><i class="fas fa-check-circle text-success me-2"></i>acme.sh (SSLè¯ä¹¦ç®¡ç†)</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card h-100 border-warning">
                                <div class="card-header bg-light">
                                    <small class="fw-bold text-warning">å®‰å…¨å·¥å…·</small>
                                </div>
                                <div class="card-body py-2">
                                    <ul class="list-unstyled mb-0 small">
                                        <li class="mb-1"><i class="fas fa-check-circle text-success me-2"></i>UFW (é˜²ç«å¢™)</li>
                                        <li class="mb-1"><i class="fas fa-check-circle text-success me-2"></i>Fail2ban (å…¥ä¾µé˜²æŠ¤)</li>
                                        <li class="mb-1"><i class="fas fa-check-circle text-success me-2"></i>DNSå·¥å…·</li>
                                        <li class="mb-1"><i class="fas fa-check-circle text-success me-2"></i>ç³»ç»Ÿå·¥å…·</li>
                                        <li class="mb-0"><i class="fas fa-check-circle text-success me-2"></i>ç½‘ç»œå·¥å…·</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- åˆå§‹åŒ–è¿›åº¦åŒºåŸŸ -->
                    <div id="init-progress" class="d-none mt-4">
                        <div class="d-flex align-items-center mb-3">
                            <i class="fas fa-rocket text-primary me-2"></i>
                            <h6 class="mb-0 text-primary">åˆå§‹åŒ–è¿›åº¦</h6>
                        </div>
                        <div class="progress mb-3" style="height: 20px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary" 
                                 role="progressbar" 
                                 style="width: 0%" 
                                 aria-valuenow="0" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                                <span class="progress-text">0%</span>
                            </div>
                        </div>
                        <div id="init-steps" class="border rounded p-3 bg-light"></div>
                    </div>
                </div>
                <div class="modal-footer bg-light">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-clock me-2 text-muted"></i>
                        <small class="text-muted me-auto">é¢„è®¡è€—æ—¶ï¼š3-5åˆ†é’Ÿ</small>
                        <button type="button" class="btn btn-primary px-4" id="init-system-btn">
                            <i class="fas fa-play me-2"></i>å¼€å§‹åˆå§‹åŒ–
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

</body>
</html>
