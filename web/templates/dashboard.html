<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.title}} - ESemail 邮件服务管理</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/css/clean-modern.css" rel="stylesheet">
    <script src="/static/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/chart.js"></script>
    <script src="/static/js/notification.js"></script>
    <script src="/static/js/dashboard.js"></script>
    <script src="/static/js/mail.js"></script>
    
    <style>
        /* 修复模态框中下拉菜单被遮挡的问题 */
        .modal-body {
            overflow: visible;
        }
        
        /* 确保下拉菜单在模态框中有足够的z-index */
        .modal .dropdown-menu,
        .modal .form-select {
            position: relative;
            z-index: 1060;
        }
        
        /* 当下拉菜单展开时提供更多空间 */
        .modal-dialog {
            margin-top: 1.75rem;
            margin-bottom: 1.75rem;
        }
        
        /* 增加用户模态框的最小高度以容纳下拉选项 */
        #add-user-modal .modal-content {
            min-height: 500px;
        }
        
        /* 修复用户模态框特殊样式 */
        #add-user-modal .modal-body {
            padding-bottom: 3rem;
            overflow: visible;
        }
        
        /* 确保select下拉选项可见 */
        .form-select:focus {
            z-index: 1061;
        }
        
        /* 锁定功能的样式 */
        .nav-link.disabled {
            color: #6c757d !important;
            pointer-events: none;
            opacity: 0.5;
        }
        
        .nav-link.disabled:hover {
            background-color: transparent !important;
        }
        
        /* 为域名选择框添加特殊样式确保可见 */
        #user-domain {
            position: relative;
            z-index: 1061;
        }
        
        /* 确保模态框不会裁剪下拉内容 */
        .modal.show .modal-dialog {
            transform: none;
        }
        
        /* 为下拉选项添加更高的z-index */
        .form-select option {
            z-index: 1062;
        }
    </style>
</head>
<body>
    <!-- 顶部导航栏 -->
    <nav class="navbar navbar-expand-lg fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                ESemail 管理控制台
            </a>
            <div class="navbar-nav ms-auto">
                <div class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle text-white" href="#" role="button" data-bs-toggle="dropdown">
                        <i class="fas fa-user-circle"></i> 管理员
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="changePassword()"><i class="fas fa-key"></i> 修改密码</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> 退出</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid" style="padding-top: 70px;">
        <div class="row">
            <!-- 侧边栏 -->
            <nav class="col-md-3 col-lg-2 d-md-block sidebar collapse" id="sidebar">
                <div class="sidebar-sticky">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link active" href="#dashboard" data-section="dashboard">
                                <i class="fas fa-chart-line"></i>
                                系统监控
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link {{if not .unlock_status.domain_config}}disabled{{end}}"
                               href="{{if .unlock_status.domain_config}}#domains{{else}}javascript:void(0){{end}}"
                               data-section="{{if .unlock_status.domain_config}}domains{{else}}locked{{end}}"
                               {{if not .unlock_status.domain_config}}onclick="showLockMessage('域名管理', '系统初始化')"{{end}}>
                                <i class="fas fa-globe"></i>
                                域名管理
                                {{if not .unlock_status.domain_config}}<i class="fas fa-lock ms-1 text-muted"></i>{{end}}
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link {{if not .unlock_status.ssl_config}}disabled{{end}}"
                               href="{{if .unlock_status.ssl_config}}#certificates{{else}}javascript:void(0){{end}}"
                               data-section="{{if .unlock_status.ssl_config}}certificates{{else}}locked{{end}}"
                               {{if not .unlock_status.ssl_config}}onclick="showLockMessage('证书管理', 'DNS验证')"{{end}}>
                                <i class="fas fa-shield-alt"></i>
                                证书管理
                                {{if not .unlock_status.ssl_config}}<i class="fas fa-lock ms-1 text-muted"></i>{{end}}
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link {{if not .unlock_status.user_mgmt}}disabled{{end}}"
                               href="{{if .unlock_status.user_mgmt}}#users{{else}}javascript:void(0){{end}}"
                               data-section="{{if .unlock_status.user_mgmt}}users{{else}}locked{{end}}"
                               {{if not .unlock_status.user_mgmt}}onclick="showLockMessage('用户管理', 'SSL证书配置')"{{end}}>
                                <i class="fas fa-users"></i>
                                用户管理
                                {{if not .unlock_status.user_mgmt}}<i class="fas fa-lock ms-1 text-muted"></i>{{end}}
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link {{if not .unlock_status.mail_service}}disabled{{end}}"
                               href="{{if .unlock_status.mail_service}}#mail{{else}}javascript:void(0){{end}}"
                               data-section="{{if .unlock_status.mail_service}}mail{{else}}locked{{end}}"
                               {{if not .unlock_status.mail_service}}onclick="showLockMessage('邮件服务', '用户管理')"{{end}}>
                                <i class="fas fa-envelope"></i>
                                邮件历史
                                {{if not .unlock_status.mail_service}}<i class="fas fa-lock ms-1 text-muted"></i>{{end}}
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#system" data-section="system">
                                <i class="fas fa-cog"></i>
                                系统设置
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- 主内容区域 -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <!-- 系统监控面板 -->
                <div id="dashboard-section" class="section-content">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3">
                        <h1 class="h2">系统监控</h1>
                        <div class="btn-toolbar mb-2 mb-md-0">
                            <button type="button" class="btn btn-outline-primary btn-sm" id="refresh-dashboard">
                                <i class="fas fa-sync-alt"></i> 刷新
                            </button>
                        </div>
                    </div>

                    <!-- 统计卡片 -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-number" id="total-users">--</div>
                                <div class="stat-label">总用户数</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card" style="background: var(--gradient-success);">
                                <div class="stat-number" id="active-domains">--</div>
                                <div class="stat-label">活跃域名</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card" style="background: var(--gradient-warning);">
                                <div class="stat-number" id="mail-queue">--</div>
                                <div class="stat-label">邮件队列</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card" style="background: var(--gradient-danger);">
                                <div class="stat-number" id="system-load">--</div>
                                <div class="stat-label">系统负载</div>
                            </div>
                        </div>
                    </div>

                    <!-- 服务状态 -->
                    <div class="row mb-4">
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header">
                                    <i class="fas fa-server"></i> 服务状态
                                </div>
                                <div class="card-body">
                                    <div id="services-list" class="row">
                                        <div class="col-12 text-center">
                                            <div class="loading-spinner"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="system-info">
                                <h5 class="mb-3"><i class="fas fa-info-circle"></i> 系统信息</h5>
                                <div class="info-item">
                                    <span class="info-label">CPU 使用率</span>
                                    <span class="info-value" id="cpu-usage">--</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">内存使用率</span>
                                    <span class="info-value" id="memory-usage">--</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">磁盘使用率</span>
                                    <span class="info-value" id="disk-usage">--</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">系统运行时间</span>
                                    <span class="info-value" id="uptime">--</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">负载平均</span>
                                    <span class="info-value" id="load-average">--</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 系统初始化面板 -->
                    <div class="row">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <i class="fas fa-rocket"></i> 系统初始化
                                    {{if .unlock_status.system_init}}
                                        <span class="badge bg-success float-end">已完成</span>
                                    {{else}}
                                        <span class="badge bg-warning float-end">待完成</span>
                                    {{end}}
                                </div>
                                <div class="card-body">
                                    {{if .unlock_status.system_init}}
                                        <p class="text-muted mb-3">✅ 系统已成功初始化，邮件服务已准备就绪</p>
                                        <div class="alert alert-success">
                                            <strong>下一步：</strong> 
                                            {{if not .unlock_status.domain_config}}
                                                前往域名管理配置您的第一个邮件域名
                                            {{else if not .unlock_status.dns_verified}}
                                                完成DNS解析验证
                                            {{else if not .unlock_status.ssl_config}}
                                                配置SSL证书
                                            {{else if not .unlock_status.user_mgmt}}
                                                创建第一个邮件用户
                                            {{else if not .unlock_status.mail_service}}
                                                启用邮件服务功能
                                            {{else}}
                                                所有设置已完成！🎉
                                            {{end}}
                                        </div>
                                    {{else}}
                                        <p class="text-muted mb-3">首次使用或重新配置系统时，请执行系统初始化以设置所有邮件服务。</p>
                                        <button class="btn btn-primary" id="init-system" onclick="initializeSystem()">
                                            <i class="fas fa-play"></i> 开始初始化
                                        </button>
                                    {{end}}
                                    <div id="init-progress" class="mt-3" style="display: none;">
                                        <div class="progress mb-3">
                                            <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                                        </div>
                                        <div id="init-steps"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 域名管理页面 -->
                <div id="domains-section" class="section-content" style="display: none;">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3">
                        <h1 class="h2">域名管理</h1>
                        <div class="btn-toolbar mb-2 mb-md-0">
                            <button type="button" class="btn btn-success" onclick="refreshDomains()">
                                <i class="fas fa-sync-alt"></i> 刷新
                            </button>
                            <button type="button" class="btn btn-primary ms-2" data-bs-toggle="modal" data-bs-target="#add-domain-modal">
                                <i class="fas fa-plus"></i> 添加域名
                            </button>
                        </div>
                    </div>
                    
                    <!-- 域名列表容器 -->
                    <div id="domains-list">
                        <div class="text-center py-4">
                            <div class="loading-spinner mb-3"></div>
                            <p class="text-muted">正在加载域名列表...</p>
                        </div>
                    </div>
                    
                    <!-- 空状态提示 -->
                    <div id="domains-empty-state" class="empty-state" style="display: none;">
                        <i class="fas fa-globe"></i>
                        <h3>暂无域名</h3>
                        <p>点击"添加域名"按钮开始配置您的第一个邮件域名</p>
                        <button type="button" class="btn btn-primary mt-3" data-bs-toggle="modal" data-bs-target="#add-domain-modal">
                            <i class="fas fa-plus"></i> 添加域名
                        </button>
                    </div>
                </div>

                <!-- 用户管理页面 -->
                <div id="users-section" class="section-content" style="display: none;">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3">
                        <h1 class="h2">用户管理</h1>
                        <div class="btn-toolbar mb-2 mb-md-0">
                            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#add-user-modal">
                                <i class="fas fa-user-plus"></i> 添加用户
                            </button>
                        </div>
                    </div>
                    <!-- 用户列表容器 -->
                    <div id="users-list">
                        <div class="text-center py-4">
                            <div class="loading-spinner mb-3"></div>
                            <p class="text-muted">正在加载用户列表...</p>
                        </div>
                    </div>
                    
                    <!-- 空状态提示 -->
                    <div id="users-empty-state" class="empty-state" style="display: none;">
                        <i class="fas fa-users"></i>
                        <h3>暂无用户</h3>
                        <p>点击"添加用户"按钮开始创建您的第一个邮件用户</p>
                        <button type="button" class="btn btn-primary mt-3" data-bs-toggle="modal" data-bs-target="#add-user-modal">
                            <i class="fas fa-user-plus"></i> 添加用户
                        </button>
                    </div>
                </div>

                <!-- 邮件管理页面 -->
                <div id="mail-section" class="section-content" style="display: none;">
                    <!-- Tab 导航 -->
                    <ul class="nav nav-tabs mb-3" id="mailTabs">
                        <li class="nav-item">
                            <a class="nav-link active" data-bs-toggle="tab" href="#mail-history">邮件历史</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#send-mail">发送邮件</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#mail-status">邮件服务状态</a>
                        </li>
                    </ul>

                    <!-- Tab 内容 -->
                    <div class="tab-content">
                        <!-- 邮件历史 Tab -->
                        <div class="tab-pane fade show active" id="mail-history">
                            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center mb-3">
                                <h3>邮件历史</h3>
                                <div class="btn-toolbar">
                                    <div class="input-group me-2">
                                        <input type="date" class="form-control" id="search-start-date" placeholder="开始日期">
                                        <input type="date" class="form-control" id="search-end-date" placeholder="结束日期">
                                        <button class="btn btn-outline-primary" type="button" onclick="searchMails()">
                                            <i class="fas fa-search"></i> 搜索
                                        </button>
                                    </div>
                                    <button type="button" class="btn btn-success" onclick="refreshMailHistory()">
                                        <i class="fas fa-sync-alt"></i> 刷新
                                    </button>
                                </div>
                            </div>
                            
                            <!-- 邮件列表 -->
                            <div class="card">
                                <div class="card-body">
                                    <div id="mail-history-table">
                                        <table class="table table-striped table-hover">
                                            <thead>
                                                <tr>
                                                    <th>时间</th>
                                                    <th>发件人</th>
                                                    <th>收件人</th>
                                                    <th>主题</th>
                                                    <th>状态</th>
                                                    <th>方向</th>
                                                    <th>大小</th>
                                                    <th>操作</th>
                                                </tr>
                                            </thead>
                                            <tbody id="mail-history-body">
                                                <tr>
                                                    <td colspan="8" class="text-center text-muted py-4">
                                                        <i class="fas fa-envelope fa-2x mb-2"></i><br>
                                                        暂无邮件记录，点击刷新获取最新数据
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 发送邮件 Tab -->
                        <div class="tab-pane fade" id="send-mail">
                            <h3>发送邮件</h3>
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="card">
                                        <div class="card-body">
                                            <form id="send-mail-form">
                                                <div class="mb-3">
                                                    <label for="mail-from" class="form-label">发件人</label>
                                                    <select class="form-select" id="mail-from" required>
                                                        <option value="">选择发件人邮箱</option>
                                                    </select>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="mail-to" class="form-label">收件人</label>
                                                    <input type="email" class="form-control" id="mail-to" 
                                                           placeholder="user@example.com" required>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="mail-subject" class="form-label">主题</label>
                                                    <input type="text" class="form-control" id="mail-subject" 
                                                           placeholder="邮件主题" required>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="mail-body" class="form-label">邮件内容</label>
                                                    <textarea class="form-control" id="mail-body" rows="8" 
                                                              placeholder="请输入邮件内容..." required></textarea>
                                                </div>
                                                <div class="d-flex justify-content-between">
                                                    <button type="button" class="btn btn-outline-secondary" onclick="clearMailForm()">
                                                        <i class="fas fa-trash"></i> 清空
                                                    </button>
                                                    <button type="submit" class="btn btn-primary">
                                                        <i class="fas fa-paper-plane"></i> 发送邮件
                                                    </button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card">
                                        <div class="card-header">
                                            <i class="fas fa-info-circle"></i> 发送提示
                                        </div>
                                        <div class="card-body">
                                            <ul class="list-unstyled">
                                                <li><i class="fas fa-check text-success"></i> 支持本地域名和外部邮件</li>
                                                <li><i class="fas fa-check text-success"></i> 自动处理邮件队列</li>
                                                <li><i class="fas fa-check text-success"></i> 失败重试机制</li>
                                                <li><i class="fas fa-check text-success"></i> 完整的发送记录</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 邮件服务状态 Tab -->
                        <div class="tab-pane fade" id="mail-status">
                            <h3>邮件服务状态</h3>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <i class="fas fa-server"></i> 服务状态
                                        </div>
                                        <div class="card-body" id="mail-server-status">
                                            <div class="text-center py-3">
                                                <i class="fas fa-spinner fa-spin"></i> 加载中...
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <i class="fas fa-list"></i> 邮件队列
                                        </div>
                                        <div class="card-body" id="mail-queue-status">
                                            <div class="text-center py-3">
                                                <i class="fas fa-spinner fa-spin"></i> 加载中...
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 证书管理页面 -->
                <div id="certificates-section" class="section-content" style="display: none;">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3">
                        <h1 class="h2">证书管理</h1>
                        <div class="btn-toolbar mb-2 mb-md-0">
                            <button type="button" class="btn btn-success" onclick="refreshCertificates()">
                                <i class="fas fa-sync-alt"></i> 刷新
                            </button>
                            <button type="button" class="btn btn-primary ms-2" data-bs-toggle="modal" data-bs-target="#issue-cert-modal">
                                <i class="fas fa-certificate"></i> 签发证书
                            </button>
                        </div>
                    </div>
                    
                    <!-- 证书列表容器 -->
                    <div id="certificates-list">
                        <div class="text-center py-4">
                            <div class="loading-spinner mb-3"></div>
                            <p class="text-muted">正在加载证书列表...</p>
                        </div>
                    </div>
                    
                    <!-- 空状态提示 -->
                    <div id="certificates-empty-state" class="empty-state" style="display: none;">
                        <i class="fas fa-shield-alt"></i>
                        <h3>暂无证书</h3>
                        <p>点击"签发证书"按钮为您的域名申请SSL/TLS证书</p>
                        <button type="button" class="btn btn-primary mt-3" data-bs-toggle="modal" data-bs-target="#issue-cert-modal">
                            <i class="fas fa-certificate"></i> 签发证书
                        </button>
                    </div>
                </div>

                <!-- 系统设置页面 -->
                <div id="system-section" class="section-content" style="display: none;">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3">
                        <h1 class="h2">系统设置</h1>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <i class="fas fa-cog"></i> 基础设置
                                </div>
                                <div class="card-body">
                                    <p class="text-muted">配置系统基础参数和邮件服务选项</p>
                                    <button class="btn btn-outline-primary">
                                        <i class="fas fa-edit"></i> 编辑设置
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <i class="fas fa-shield-alt"></i> 安全设置
                                </div>
                                <div class="card-body">
                                    <p class="text-muted">配置防火墙规则和安全策略</p>
                                    <button class="btn btn-outline-primary">
                                        <i class="fas fa-lock"></i> 安全配置
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        // 认证令牌管理
        const authToken = localStorage.getItem('auth_token');
        
        // 检查认证状态
        async function checkAuth() {
            if (!authToken) {
                console.log('没有找到认证令牌，跳转到登录页面');
                redirectToLogin();
                return false;
            }
            
            // 验证令牌是否有效
            try {
                const response = await fetch('/api/v1/auth/me', {
                    headers: {
                        'Authorization': 'Bearer ' + authToken
                    }
                });
                
                if (!response.ok) {
                    console.log('认证令牌无效，跳转到登录页面');
                    redirectToLogin();
                    return false;
                }
                
                console.log('认证令牌有效');
                return true;
            } catch (error) {
                console.error('验证认证令牌失败:', error);
                redirectToLogin();
                return false;
            }
        }
        
        // 跳转到登录页面
        function redirectToLogin() {
            localStorage.removeItem('auth_token');
            localStorage.removeItem('auth_user');
            window.location.href = '/login';
        }
        
        // 带认证的API请求
        function apiRequest(url, options = {}) {
            if (!options.headers) {
                options.headers = {};
            }
            if (authToken) {
                options.headers['Authorization'] = 'Bearer ' + authToken;
            }
            options.headers['Content-Type'] = 'application/json';
            
            return fetch(url, options).then(response => {
                if (response.status === 401) {
                    redirectToLogin();
                    throw new Error('Authentication required');
                }
                return response;
            });
        }
        
        // 登出功能
        async function logout() {
            if (await showConfirm('确定要退出吗？', '确认退出')) {
                apiRequest('/api/v1/auth/logout', { method: 'POST' })
                .finally(() => {
                    localStorage.removeItem('auth_token');
                    localStorage.removeItem('auth_user');
                    window.location.href = '/login';
                });
            }
        }
        
        // 修改密码功能
        async function changePassword() {
            const oldPassword = await showPrompt('请输入当前密码：', '修改密码', '', { inputType: 'password' });
            if (!oldPassword) return;

            const newPassword = await showPrompt('请输入新密码（至少8位）：', '设置新密码', '', { inputType: 'password' });
            if (!newPassword || newPassword.length < 8) {
                showAlert('新密码长度至少8位', '密码验证失败', 'warning');
                return;
            }

            const confirmPassword = await showPrompt('请确认新密码：', '确认新密码', '', { inputType: 'password' });
            if (newPassword !== confirmPassword) {
                showAlert('两次输入的密码不一致', '密码验证失败', 'warning');
                return;
            }

            apiRequest('/api/v1/auth/change-password', {
                method: 'POST',
                body: JSON.stringify({
                    old_password: oldPassword,
                    new_password: newPassword
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    showAlert('密码修改成功', '操作成功', 'success');
                } else {
                    showAlert('密码修改失败：' + data.error, '操作失败', 'error');
                }
            })
            .catch(error => {
                console.error('修改密码失败:', error);
                showAlert('修改密码失败', '网络错误', 'error');
            });
        }
        
        // 页面切换逻辑
        document.addEventListener('DOMContentLoaded', async function() {
            // 检查认证状态
            if (!(await checkAuth())) {
                return;
            }
            
            // 显示功能锁定消息的函数
            window.showLockMessage = function(feature, requiredStep) {
                alert(`⚠️ ${feature}功能尚未解锁\n\n请先完成：${requiredStep}`);
            }
            
            // 检查是否需要显示初始化弹窗
            if ({{if not .is_initialized}}true{{else}}false{{end}}) {
                const modal = new bootstrap.Modal(document.getElementById('system-init-modal'), {
                    backdrop: 'static',
                    keyboard: false
                });
                modal.show();
            }
            
            const navLinks = document.querySelectorAll('.sidebar .nav-link');
            const sections = document.querySelectorAll('.section-content');

            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // 更新导航状态
                    navLinks.forEach(l => l.classList.remove('active'));
                    this.classList.add('active');
                    
                    // 显示对应页面
                    const targetSection = this.getAttribute('data-section') + '-section';
                    sections.forEach(section => {
                        section.style.display = 'none';
                    });
                    
                    const target = document.getElementById(targetSection);
                    if (target) {
                        target.style.display = 'block';
                        target.classList.add('fade-in-up');
                    }
                    
                    // 根据不同页面加载对应数据
                    if (targetSection === 'dashboard-section') {
                        loadDashboardData();
                    } else if (targetSection === 'domains-section') {
                        loadDomains();
                    } else if (targetSection === 'users-section') {
                        loadUsers();
                        loadDomainsForUserForm();
                    } else if (targetSection === 'mail-section') {
                        loadUserEmailOptions();
                    } else if (targetSection === 'certificates-section') {
                        loadCertificates();
                    }
                });
            });
            
            // 初始化加载数据
            loadDashboardData();
            
            // 设置自动刷新
            setInterval(function() {
                if (document.getElementById('dashboard-section').style.display !== 'none') {
                    loadDashboardData();
                }
            }, 30000); // 30秒自动刷新
            
            // 模态框事件绑定 - 确保在DOM加载完成后绑定
            // 用户模态框事件监听 - 当模态框显示时加载域名选项
            const addUserModal = document.getElementById('add-user-modal');
            if (addUserModal) {
                console.log('用户模态框元素找到，绑定事件...');
                addUserModal.addEventListener('show.bs.modal', function () {
                    console.log('用户模态框显示事件触发，开始加载域名选项');
                    loadDomainOptions();
                });
            } else {
                console.error('未找到用户模态框元素: add-user-modal');
            }
            
            // 证书模态框事件监听 - 当模态框显示时加载域名选项
            const issueCertModal = document.getElementById('issue-cert-modal');
            if (issueCertModal) {
                issueCertModal.addEventListener('show.bs.modal', function () {
                    loadCertDomainOptions();
                });
            }
            
            // 弹窗初始化按钮事件监听
            const initSystemBtn = document.getElementById('init-system-btn');
            if (initSystemBtn) {
                initSystemBtn.addEventListener('click', function () {
                    initializeSystemFromModal();
                });
            }
            
            // 用户创建表单提交事件
            const addUserForm = document.getElementById('add-user-form');
            if (addUserForm) {
                addUserForm.addEventListener('submit', async function (e) {
                    e.preventDefault();
                    await createUser();
                });
            }
            
            // 邮件标签点击事件监听 - 当切换到发送邮件标签时加载邮箱选项
            const sendMailTab = document.querySelector('a[href="#send-mail"]');
            if (sendMailTab) {
                sendMailTab.addEventListener('shown.bs.tab', function () {
                    console.log('发送邮件标签被激活，开始加载邮箱选项');
                    loadUserEmailOptions();
                });
            } else {
                console.error('未找到发送邮件标签');
            }
            
            // 当邮件页面被激活时，立即加载邮箱选项
            const mailNavLink = document.querySelector('a[data-section="mail"]');
            if (mailNavLink) {
                mailNavLink.addEventListener('click', function() {
                    setTimeout(() => {
                        loadUserEmailOptions();
                    }, 100);
                });
            }
        });

        // 加载仪表板数据
        function loadDashboardData() {
            // 加载健康状态
            apiRequest('/api/v1/health')
                .then(response => response.json())
                .then(data => {
                    updateSystemStats(data);
                    updateServicesStatus(data.services || []);
                })
                .catch(error => {
                    console.error('Error loading health data:', error);
                    // 显示错误状态
                    document.getElementById('services-list').innerHTML = 
                        '<div class="col-12"><div class="alert alert-warning">无法加载服务状态数据</div></div>';
                });
        }

        // 更新系统统计
        function updateSystemStats(data) {
            if (data.system_info) {
                document.getElementById('cpu-usage').textContent = data.system_info.cpu_usage + '%';
                document.getElementById('memory-usage').textContent = data.system_info.memory_usage.toFixed(1) + '%';
                document.getElementById('disk-usage').textContent = data.system_info.disk_usage + '%';
                document.getElementById('uptime').textContent = data.system_info.uptime || 'N/A';
                document.getElementById('load-average').textContent = data.system_info.load_average || 'N/A';
                document.getElementById('system-load').textContent = data.system_info.cpu_usage + '%';
            }
            
            // 更新统计卡片
            document.getElementById('total-users').textContent = data.stats?.total_users || '0';
            document.getElementById('active-domains').textContent = data.stats?.active_domains || '0';
            document.getElementById('mail-queue').textContent = data.stats?.mail_queue || '0';
        }

        // 更新服务状态
        function updateServicesStatus(services) {
            const container = document.getElementById('services-list');
            container.innerHTML = '';
            
            if (!services || services.length === 0) {
                container.innerHTML = '<div class="col-12"><div class="alert alert-info">暂无服务状态信息</div></div>';
                return;
            }
            
            services.forEach(service => {
                const statusClass = service.status === 'healthy' ? 'success' : 
                                  service.status === 'warning' ? 'warning' : 'danger';
                                  
                const serviceCard = document.createElement('div');
                serviceCard.className = 'col-md-6 mb-3';
                serviceCard.innerHTML = `
                    <div class="service-card ${service.status}">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">${service.name}</h6>
                                <small class="text-muted">${service.message || '运行正常'}</small>
                            </div>
                            <div>
                                <span class="status-indicator status-${service.status}"></span>
                                <span class="badge bg-${statusClass}">${service.status}</span>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(serviceCard);
            });
        }

        // 系统初始化
        function initializeSystem() {
            const button = document.getElementById('init-system');
            const progress = document.getElementById('init-progress');
            const steps = document.getElementById('init-steps');
            
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 初始化中...';
            progress.style.display = 'block';
            
            // 模拟初始化数据
            const initData = {
                domain: 'example.com',
                admin_email: 'admin@example.com',
                admin_password: 'admin123',
                smtp_host: 'localhost',
                smtp_port: 587
            };
            
            fetch('/api/v1/system/init', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(initData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.querySelector('.progress-bar').style.width = '100%';
                    steps.innerHTML = '<div class="alert alert-success"><i class="fas fa-check"></i> 系统初始化完成！</div>';
                    button.innerHTML = '<i class="fas fa-check"></i> 初始化完成';
                    setTimeout(() => {
                        // 初始化完成后刷新整个页面以更新状态
                        window.location.reload();
                    }, 2000);
                } else {
                    steps.innerHTML = '<div class="alert alert-danger"><i class="fas fa-times"></i> 初始化失败: ' + (data.message || '未知错误') + '</div>';
                    button.innerHTML = '<i class="fas fa-play"></i> 重试初始化';
                    button.disabled = false;
                }
            })
            .catch(error => {
                console.error('Init error:', error);
                steps.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle"></i> 网络连接错误，请检查服务状态</div>';
                button.innerHTML = '<i class="fas fa-times"></i> 网络错误';
                button.disabled = false;
            });
        }

        // 刷新按钮
        document.getElementById('refresh-dashboard').addEventListener('click', function() {
            loadDashboardData();
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 刷新中...';
            setTimeout(() => {
                this.innerHTML = '<i class="fas fa-sync-alt"></i> 刷新';
            }, 1000);
        });

        // 域名管理相关函数
        async function loadDomains() {
            const domainsListContainer = document.getElementById('domains-list');
            const emptyStateContainer = document.getElementById('domains-empty-state');
            
            try {
                const response = await apiRequest('/api/v1/domains');
                const domains = await response.json();
                
                if (domains && domains.length > 0) {
                    emptyStateContainer.style.display = 'none';
                    domainsListContainer.style.display = 'block';
                    
                    let html = '<div class="row">';
                    domains.forEach(domain => {
                        const statusBadge = domain.active ? 
                            '<span class="badge bg-success">活跃</span>' : 
                            '<span class="badge bg-secondary">禁用</span>';
                            
                        html += `
                            <div class="col-md-6 col-lg-4 mb-3">
                                <div class="card h-100">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0">${domain.domain || domain.name}</h6>
                                        ${statusBadge}
                                    </div>
                                    <div class="card-body">
                                        <p class="text-muted small mb-2">状态: ${domain.status || 'active'}</p>
                                        <p class="text-muted small mb-3">创建时间: ${new Date(domain.created_at).toLocaleDateString()}</p>
                                        <div class="btn-group w-100" role="group">
                                            <button class="btn btn-outline-primary btn-sm" onclick="viewDNSRecords('${domain.domain || domain.name}')">
                                                <i class="fas fa-eye"></i> DNS记录
                                            </button>
                                            <button class="btn btn-outline-danger btn-sm" onclick="deleteDomain('${domain.domain || domain.name}')">
                                                <i class="fas fa-trash"></i> 删除
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    domainsListContainer.innerHTML = html;
                } else {
                    domainsListContainer.style.display = 'none';
                    emptyStateContainer.style.display = 'block';
                }
            } catch (error) {
                console.error('加载域名失败:', error);
                domainsListContainer.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i> 
                        加载域名列表失败：${error.message}
                        <button class="btn btn-outline-warning btn-sm ms-2" onclick="loadDomains()">重试</button>
                    </div>
                `;
            }
        }

        // 刷新域名列表
        function refreshDomains() {
            loadDomains();
        }

        // 查看DNS记录
        async function viewDNSRecords(domain) {
            try {
                const response = await apiRequest(`/api/v1/domains/${domain}/dns`);
                const records = await response.json();
                
                let html = `
                    <div class="modal fade" id="dns-records-modal" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">DNS记录 - ${domain}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle"></i>
                                        请在您的DNS服务商处添加以下记录以启用邮件服务
                                    </div>
                                    <div class="table-responsive">
                                        <table class="table table-bordered">
                                            <thead>
                                                <tr>
                                                    <th>类型</th>
                                                    <th>名称</th>
                                                    <th>值</th>
                                                    <th>TTL</th>
                                                    <th>状态</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                `;
                
                records.forEach(record => {
                    const statusBadge = record.status === 'found' ? 
                        '<span class="badge bg-success">已配置</span>' : 
                        record.status === 'missing' ? 
                        '<span class="badge bg-warning">未配置</span>' : 
                        '<span class="badge bg-danger">错误</span>';
                        
                    html += `
                        <tr>
                            <td><code>${record.type}</code></td>
                            <td><code>${record.name}</code></td>
                            <td><code class="text-break">${record.value}</code></td>
                            <td>${record.ttl}</td>
                            <td>${statusBadge}</td>
                        </tr>
                    `;
                });
                
                html += `
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                                    <button type="button" class="btn btn-primary" onclick="recheckDNS('${domain}')">重新检查</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // 移除旧的模态框
                const oldModal = document.getElementById('dns-records-modal');
                if (oldModal) {
                    oldModal.remove();
                }
                
                // 添加新的模态框
                document.body.insertAdjacentHTML('beforeend', html);
                
                // 显示模态框
                const modal = new bootstrap.Modal(document.getElementById('dns-records-modal'));
                modal.show();
                
            } catch (error) {
                console.error('获取DNS记录失败:', error);
                alert('获取DNS记录失败: ' + error.message);
            }
        }

        // 重新检查DNS
        async function recheckDNS(domain) {
            try {
                // 显示检查中提示
                const modal = document.getElementById('dns-records-modal');
                const modalBody = modal.querySelector('.modal-body');
                const originalContent = modalBody.innerHTML;
                
                modalBody.innerHTML = `
                    <div class="text-center py-4">
                        <div class="loading-spinner mb-3"></div>
                        <h5>正在检查DNS记录...</h5>
                        <p class="text-muted">这可能需要几秒钟时间</p>
                    </div>
                `;
                
                const response = await apiRequest(`/api/v1/domains/${domain}/dns/check`, {
                    method: 'POST'
                });
                const result = await response.json();
                
                if (response.ok) {
                    // 更新模态框内容显示检查结果
                    let html = `
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            DNS记录检查完成 - ${new Date().toLocaleString()}
                        </div>
                        <div class="table-responsive">
                            <table class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th>类型</th>
                                        <th>名称</th>
                                        <th>值</th>
                                        <th>TTL</th>
                                        <th>状态</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    result.records.forEach(record => {
                        const statusBadge = record.status === 'found' ? 
                            '<span class="badge bg-success">已配置</span>' : 
                            record.status === 'missing' ? 
                            '<span class="badge bg-warning">未配置</span>' : 
                            '<span class="badge bg-danger">错误</span>';
                            
                        html += `
                            <tr>
                                <td><code>${record.type}</code></td>
                                <td><code>${record.name}</code></td>
                                <td><code class="text-break">${record.value}</code></td>
                                <td>${record.ttl || 300}</td>
                                <td>${statusBadge}</td>
                            </tr>
                        `;
                    });
                    
                    html += `
                                    </tbody>
                                </table>
                            </div>
                    `;
                    
                    modalBody.innerHTML = html;
                    
                    // 显示成功提示
                    const alertHtml = `
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            <i class="fas fa-check-circle"></i> DNS记录检查完成！
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    `;
                    modalBody.insertAdjacentHTML('afterbegin', alertHtml);
                    
                } else {
                    modalBody.innerHTML = originalContent;
                    alert('DNS检查失败: ' + result.error);
                }
            } catch (error) {
                console.error('DNS检查失败:', error);
                alert('DNS检查失败: ' + error.message);
            }
        }

        // 从弹窗执行系统初始化
        function initializeSystemFromModal() {
            const button = document.getElementById('init-system-btn');
            const modal = document.getElementById('system-init-modal');
            const progressContainer = modal.querySelector('#init-progress');
            const stepsContainer = modal.querySelector('#init-steps');
            const progressBar = modal.querySelector('.progress-bar');
            const progressText = modal.querySelector('.progress-text');
            
            // 禁用按钮并显示进度
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>初始化中...';
            
            if (progressContainer) {
                progressContainer.classList.remove('d-none');
            }
            
            // 模拟进度更新
            const updateProgress = (value, message) => {
                if (progressBar) {
                    progressBar.style.width = value + '%';
                    progressBar.setAttribute('aria-valuenow', value);
                }
                if (progressText) {
                    progressText.textContent = value + '%';
                }
                if (stepsContainer && message) {
                    stepsContainer.innerHTML = `
                        <div class="d-flex align-items-center text-primary">
                            <i class="fas fa-cog fa-spin me-2"></i>
                            <span>${message}</span>
                        </div>
                    `;
                }
            };
            
            // 模拟初始化步骤
            updateProgress(10, '正在检查系统环境...');
            
            setTimeout(() => {
                updateProgress(30, '正在安装邮件服务组件...');
            }, 1000);
            
            setTimeout(() => {
                updateProgress(60, '正在配置安全工具...');
            }, 2000);
            
            setTimeout(() => {
                updateProgress(90, '正在完成最终配置...');
            }, 3000);
            
            // 调用系统初始化API
            setTimeout(() => {
                fetch('/api/v1/system/init', {
                    method: 'POST',
                    headers: getAuthHeaders()
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateProgress(100, '');
                        if (stepsContainer) {
                            stepsContainer.innerHTML = `
                                <div class="alert alert-success border-0 mb-0">
                                    <i class="fas fa-check-circle me-2"></i>
                                    <strong>系统初始化完成！</strong><br>
                                    <small class="text-muted">所有邮件服务已成功安装并配置。</small>
                                </div>
                            `;
                        }
                        button.innerHTML = '<i class="fas fa-check me-2"></i>初始化完成';
                        
                        setTimeout(() => {
                            // 关闭弹窗
                            const modalInstance = bootstrap.Modal.getInstance(modal);
                            if (modalInstance) {
                                modalInstance.hide();
                            }
                            // 刷新页面以更新状态
                            window.location.reload();
                        }, 2000);
                    } else {
                        if (stepsContainer) {
                            stepsContainer.innerHTML = `
                                <div class="alert alert-danger border-0 mb-0">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    <strong>初始化失败</strong><br>
                                    <small>${data.message || '未知错误'}</small>
                                </div>
                            `;
                        }
                        button.disabled = false;
                        button.innerHTML = '<i class="fas fa-redo me-2"></i>重试';
                    }
                })
                .catch(error => {
                    console.error('Modal init error:', error);
                    if (stepsContainer) {
                        stepsContainer.innerHTML = `
                            <div class="alert alert-danger border-0 mb-0">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <strong>网络错误</strong><br>
                                <small>请检查网络连接后重试</small>
                            </div>
                        `;
                    }
                    button.disabled = false;
                    button.innerHTML = '<i class="fas fa-redo me-2"></i>重试';
                });
            }, 4000);
        }

        // 邮件管理相关函数
        async function loadUserEmailOptions() {
            console.log('开始加载邮箱选项...');
            try {
                // 获取用户列表
                const response = await apiRequest('/api/v1/users');
                console.log('用户API响应状态:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const users = await response.json();
                console.log('获取到的用户数据:', users);
                
                const fromSelect = document.getElementById('mail-from');
                if (!fromSelect) {
                    console.error('未找到mail-from选择框');
                    return;
                }
                
                fromSelect.innerHTML = '<option value="">选择发件人邮箱</option>';
                
                if (users && users.length > 0) {
                    console.log(`正在添加 ${users.length} 个邮箱选项`);
                    users.forEach(user => {
                        if (user.email) {
                            const option = document.createElement('option');
                            option.value = user.email;
                            option.textContent = `${user.name || user.email} <${user.email}>`;
                            fromSelect.appendChild(option);
                            console.log('已添加邮箱选项:', user.email);
                        }
                    });
                    console.log('邮箱选项加载完成');
                } else {
                    console.log('用户列表为空，显示提示信息');
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = '暂无可用邮箱用户，请先创建用户';
                    option.disabled = true;
                    fromSelect.appendChild(option);
                }
            } catch (error) {
                console.error('加载邮箱选项失败:', error);
                const fromSelect = document.getElementById('mail-from');
                if (fromSelect) {
                    fromSelect.innerHTML = '<option value="">加载邮箱失败</option>';
                }
            }
        }

        // 用户管理相关函数
        async function loadUsers() {
            console.log('开始加载用户列表...');
            const usersListContainer = document.getElementById('users-list');
            const emptyStateContainer = document.getElementById('users-empty-state');
            
            if (!usersListContainer) {
                console.error('未找到用户列表容器');
                return;
            }
            
            try {
                const response = await apiRequest('/api/v1/users');
                console.log('用户API响应状态:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const users = await response.json();
                console.log('获取到的用户数据:', users);
                
                if (users && users.length > 0) {
                    if (emptyStateContainer) emptyStateContainer.style.display = 'none';
                    usersListContainer.style.display = 'block';
                    
                    let html = '<div class="table-responsive"><table class="table table-striped"><thead><tr>';
                    html += '<th>邮箱</th><th>姓名</th><th>域名</th><th>状态</th><th>配额</th><th>创建时间</th><th>操作</th>';
                    html += '</tr></thead><tbody>';
                    
                    users.forEach(user => {
                        const statusBadge = user.active ? 
                            '<span class="badge bg-success">活跃</span>' : 
                            '<span class="badge bg-secondary">禁用</span>';
                        
                        const quota = user.quota ? `${(user.quota/1024/1024).toFixed(0)}MB` : '无限制';
                        const createdAt = new Date(user.created_at).toLocaleDateString();
                        
                        html += `
                            <tr>
                                <td>${user.email}</td>
                                <td>${user.name}</td>
                                <td>${user.domain}</td>
                                <td>${statusBadge}</td>
                                <td>${quota}</td>
                                <td>${createdAt}</td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-warning" onclick="editUser('${user.id}')">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-outline-info" onclick="resetUserPassword('${user.id}')">
                                            <i class="fas fa-key"></i>
                                        </button>
                                        <button class="btn btn-outline-danger" onclick="deleteUser('${user.id}')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    });
                    
                    html += '</tbody></table></div>';
                    usersListContainer.innerHTML = html;
                } else {
                    usersListContainer.style.display = 'none';
                    if (emptyStateContainer) emptyStateContainer.style.display = 'block';
                }
            } catch (error) {
                console.error('加载用户列表失败:', error);
                usersListContainer.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i> 
                        加载用户列表失败：${error.message}
                        <button class="btn btn-outline-warning btn-sm ms-2" onclick="loadUsers()">重试</button>
                    </div>
                `;
            }
        }

        // 创建用户
        async function createUser() {
            const form = document.getElementById('add-user-form');
            const formData = new FormData(form);
            
            const emailLocal = formData.get('email_local');
            const domain = formData.get('domain');
            const name = formData.get('name');
            const password = formData.get('password');
            const quota = parseInt(formData.get('quota')) * 1024 * 1024; // 转换为字节
            const active = formData.has('active');
            
            if (!emailLocal || !domain || !name || !password) {
                alert('请填写所有必填字段');
                return;
            }
            
            const email = `${emailLocal}@${domain}`;
            
            try {
                const response = await apiRequest('/api/v1/users', {
                    method: 'POST',
                    body: JSON.stringify({
                        email: email,
                        name: name,
                        password: password,
                        quota: quota,
                        active: active
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('用户创建成功:', result);
                    showAlert('用户创建成功！', '操作成功', 'success');
                    
                    // 关闭模态框
                    const modal = bootstrap.Modal.getInstance(document.getElementById('add-user-modal'));
                    if (modal) {
                        modal.hide();
                    }
                    
                    // 重置表单
                    form.reset();
                    
                    // 刷新用户列表
                    loadUsers();
                } else {
                    const error = await response.json();
                    showAlert('用户创建失败: ' + (error.error || '未知错误'), '操作失败', 'error');
                }
            } catch (error) {
                console.error('创建用户失败:', error);
                showAlert('创建用户失败: ' + error.message, '网络错误', 'error');
            }
        }

        // 刷新用户列表
        function refreshUsers() {
            loadUsers();
        }

        // 编辑用户（暂时只显示提示）
        function editUser(userId) {
            alert('编辑用户功能将在后续版本中实现');
        }

        // 重置用户密码
        async function resetUserPassword(userId) {
            if (!confirm('确定要重置该用户的密码吗？')) {
                return;
            }
            
            try {
                const response = await apiRequest(`/api/v1/users/${userId}/reset-password`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert(`密码重置成功！新密码：${result.new_password}`);
                } else {
                    const error = await response.json();
                    alert('密码重置失败: ' + (error.error || '未知错误'));
                }
            } catch (error) {
                console.error('重置密码失败:', error);
                alert('重置密码失败: ' + error.message);
            }
        }

        // 删除用户
        async function deleteUser(userId) {
            if (!(await showConfirm('确定要删除该用户吗？此操作不可撤销。', '删除用户确认', { dangerConfirm: true }))) {
                return;
            }
            
            try {
                const response = await apiRequest(`/api/v1/users/${userId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showAlert('用户删除成功', '操作成功', 'success');
                    loadUsers(); // 刷新列表
                } else {
                    const error = await response.json();
                    alert('删除用户失败: ' + (error.error || '未知错误'));
                }
            } catch (error) {
                console.error('删除用户失败:', error);
                alert('删除用户失败: ' + error.message);
            }
        }

        // 加载域名选项到用户表单
        async function loadDomainOptions() {
            console.log('开始加载域名选项...');
            try {
                const response = await apiRequest('/api/v1/domains');
                console.log('域名API响应状态:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const domains = await response.json();
                console.log('获取到的域名数据:', domains);
                
                const domainSelect = document.getElementById('user-domain');
                if (!domainSelect) {
                    console.error('未找到user-domain选择框');
                    return;
                }
                
                domainSelect.innerHTML = '<option value="">选择域名</option>';
                
                if (domains && domains.length > 0) {
                    console.log(`正在添加 ${domains.length} 个域名选项`);
                    domains.forEach(domain => {
                        const domainName = domain.domain || domain.name;
                        if (domainName) {
                            const option = document.createElement('option');
                            option.value = domainName;
                            option.textContent = domainName;
                            domainSelect.appendChild(option);
                            console.log('已添加域名选项:', domainName);
                        }
                    });
                } else {
                    console.log('没有找到可用域名');
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = '暂无可用域名，请先添加域名';
                    option.disabled = true;
                    domainSelect.appendChild(option);
                }
            } catch (error) {
                console.error('加载域名选项失败:', error);
                const domainSelect = document.getElementById('user-domain');
                if (domainSelect) {
                    domainSelect.innerHTML = `<option value="">加载域名失败: ${error.message}</option>`;
                }
            }
        }

        // 删除域名
        async function deleteDomain(domain) {
            if (!confirm(`确定要删除域名 ${domain} 吗？此操作不可撤销。`)) {
                return;
            }

            try {
                const response = await apiRequest(`/api/v1/domains/${domain}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    alert('域名删除成功');
                    loadDomains(); // 重新加载域名列表
                } else {
                    const error = await response.json();
                    alert('删除失败: ' + error.error);
                }
            } catch (error) {
                console.error('删除域名失败:', error);
                alert('删除失败: ' + error.message);
            }
        }
        
        // 证书管理相关函数
        async function loadCertificates() {
            const certificatesListContainer = document.getElementById('certificates-list');
            const emptyStateContainer = document.getElementById('certificates-empty-state');
            
            try {
                const response = await apiRequest('/api/v1/certificates');
                const certificates = await response.json();
                
                if (certificates && certificates.length > 0) {
                    emptyStateContainer.style.display = 'none';
                    certificatesListContainer.style.display = 'block';
                    
                    let html = '<div class="row">';
                    certificates.forEach(cert => {
                        const statusBadge = cert.status === 'valid' ? 
                            '<span class="badge bg-success">有效</span>' : 
                            cert.status === 'expired' ?
                            '<span class="badge bg-danger">已过期</span>' :
                            '<span class="badge bg-warning">即将过期</span>';
                        
                        const expiryDate = cert.expires_at ? 
                            new Date(cert.expires_at).toLocaleDateString() : 
                            '未知';
                            
                        html += `
                            <div class="col-md-6 col-lg-4 mb-3">
                                <div class="card h-100">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0">${cert.domain}</h6>
                                        ${statusBadge}
                                    </div>
                                    <div class="card-body">
                                        <p class="text-muted small mb-2">类型: ${cert.type || 'SSL'}</p>
                                        <p class="text-muted small mb-2">到期时间: ${expiryDate}</p>
                                        <p class="text-muted small mb-3">签发商: ${cert.issuer || 'Let\'s Encrypt'}</p>
                                        <div class="btn-group w-100" role="group">
                                            <button class="btn btn-outline-primary btn-sm" onclick="renewCertificate('${cert.domain}')">
                                                <i class="fas fa-sync-alt"></i> 续期
                                            </button>
                                            <button class="btn btn-outline-danger btn-sm" onclick="deleteCertificate('${cert.domain}')">
                                                <i class="fas fa-trash"></i> 删除
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    certificatesListContainer.innerHTML = html;
                } else {
                    certificatesListContainer.style.display = 'none';
                    emptyStateContainer.style.display = 'block';
                }
            } catch (error) {
                console.error('加载证书失败:', error);
                certificatesListContainer.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i> 
                        加载证书列表失败：${error.message}
                        <button class="btn btn-outline-warning btn-sm ms-2" onclick="loadCertificates()">重试</button>
                    </div>
                `;
            }
        }

        // 刷新证书列表
        function refreshCertificates() {
            loadCertificates();
        }

        // 续期证书
        async function renewCertificate(domain) {
            if (!confirm(`确定要为域名 ${domain} 续期证书吗？`)) {
                return;
            }

            try {
                const response = await apiRequest('/api/v1/certificates/renew', {
                    method: 'POST',
                    body: JSON.stringify({ domain: domain })
                });

                if (response.ok) {
                    alert('证书续期成功');
                    loadCertificates();
                } else {
                    const error = await response.json();
                    alert('续期失败: ' + error.error);
                }
            } catch (error) {
                console.error('续期证书失败:', error);
                alert('续期失败: ' + error.message);
            }
        }

        // 删除证书（带UI确认，可复制信息）
        async function deleteCertificate(domain) {
            const html = `
                <div class="mb-2">请确认要删除以下域名的证书：</div>
                <pre class="bg-light p-2 border rounded small">${domain}</pre>
                <div class="text-danger small">删除后将回退为系统默认证书（snakeoil），请尽快重新签发正式证书。</div>
            `;
            const ok = await showConfirm(html, '删除证书确认', { dangerConfirm: true, html: true });
            if (!ok) return;

            try {
                const resp = await apiRequest(`/api/v1/certificates/${encodeURIComponent(domain)}`, { method: 'DELETE' });
                if (resp.ok) {
                    showAlert('证书已删除，服务将使用默认证书运行。', '操作成功', 'success');
                    refreshCertificates();
                } else {
                    const err = await resp.json().catch(() => ({}));
                    showAlert('删除证书失败: ' + (err.error || resp.statusText), '操作失败', 'error');
                }
            } catch (e) {
                console.error('删除证书失败: ', e);
                showAlert('删除证书失败: ' + e.message, '网络错误', 'error');
            }
        }

        // 加载域名选项到证书表单
        async function loadCertDomainOptions() {
            try {
                const response = await apiRequest('/api/v1/domains');
                const domains = await response.json();
                
                const domainSelect = document.getElementById('cert-domain');
                domainSelect.innerHTML = '<option value="">选择要签发证书的域名</option>';
                
                if (domains && domains.length > 0) {
                    domains.forEach(domain => {
                        const option = document.createElement('option');
                        option.value = domain.domain || domain.name;
                        option.textContent = domain.domain || domain.name;
                        domainSelect.appendChild(option);
                    });
                } else {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = '暂无可用域名，请先添加域名';
                    option.disabled = true;
                    domainSelect.appendChild(option);
                }
            } catch (error) {
                console.error('加载证书域名选项失败:', error);
                const domainSelect = document.getElementById('cert-domain');
                domainSelect.innerHTML = '<option value="">加载域名失败</option>';
            }
        }

        // 页面加载完成后的初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 其他初始化代码...
        });
        
    </script>

    <!-- 添加域名模态框 -->
    <div class="modal fade" id="add-domain-modal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">添加域名</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-8">
                            <form id="add-domain-form">
                                <div class="mb-3">
                                    <label for="domain-name" class="form-label">域名</label>
                                    <input type="text" class="form-control" id="domain-name" name="domain" required placeholder="example.com">
                                    <div class="form-text">请输入完整的域名，如：example.com</div>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="domain-active" name="active" checked>
                                    <label class="form-check-label" for="domain-active">启用域名</label>
                                </div>
                            </form>
                        </div>
                        <div class="col-md-4">
                            <div class="card h-100">
                                <div class="card-header"><i class="fas fa-info-circle"></i> 提示</div>
                                <div class="card-body">
                                    <ul class="list-unstyled small">
                                        <li>建议使用你的业务主域名</li>
                                        <li>创建后可立即申请证书与添加用户</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" form="add-domain-form" class="btn btn-primary" id="add-domain-submit">添加域名</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加用户模态框 -->
    <div class="modal fade" id="add-user-modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">添加用户</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="add-user-form">
                        <div class="row">
                            <div class="col-md-8">
                                <label for="user-email-local" class="form-label">邮箱地址</label>
                                <input type="text" class="form-control" id="user-email-local" name="email_local" required placeholder="用户名">
                            </div>
                            <div class="col-md-4">
                                <label for="user-domain" class="form-label">域名</label>
                                <select class="form-select" id="user-domain" name="domain" required>
                                    <option value="">选择域名</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="user-name" class="form-label">姓名</label>
                            <input type="text" class="form-control" id="user-name" name="name" required placeholder="用户姓名">
                        </div>
                        <div class="mb-3">
                            <label for="user-password" class="form-label">密码</label>
                            <input type="password" class="form-control" id="user-password" name="password" required placeholder="至少8个字符">
                        </div>
                        <div class="mb-3">
                            <label for="user-quota" class="form-label">邮箱配额 (MB)</label>
                            <input type="number" class="form-control" id="user-quota" name="quota" value="1024" min="1">
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="user-active" name="active" checked>
                            <label class="form-check-label" for="user-active">启用用户</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" form="add-user-form" class="btn btn-primary">创建用户</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 签发证书模态框 -->
    <div class="modal fade" id="issue-cert-modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">签发SSL证书</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="issue-cert-form">
                        <div class="mb-3">
                            <label for="cert-email" class="form-label">Let's Encrypt 账户邮箱 <span class="text-danger">*</span></label>
                            <input type="email" class="form-control" id="cert-email" name="email" required
                                   placeholder="用于接收证书到期通知和重要通知">
                            <div class="form-text">
                                <i class="fas fa-info-circle text-primary"></i>
                                此邮箱将用于注册Let's Encrypt账户，接收证书相关通知。请确保邮箱有效且可以正常接收邮件。
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="cert-domain" class="form-label">域名</label>
                            <select class="form-select" id="cert-domain" name="domain" required>
                                <option value="">选择要签发证书的域名</option>
                            </select>
                            <div class="form-text">请选择已配置DNS记录的域名</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">证书类型</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="cert_type" id="cert-mail" value="mail" checked>
                                <label class="form-check-label" for="cert-mail">
                                    <strong>邮件服务器证书 (mail.domain.com)</strong>
                                </label>
                                <div class="form-text text-success">推荐：专用于邮件服务器的标准证书</div>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="cert_type" id="cert-wildcard" value="wildcard">
                                <label class="form-check-label" for="cert-wildcard">
                                    <strong>通配符证书 (*.domain.com)</strong>
                                </label>
                                <div class="form-text text-info">覆盖所有子域名，仅支持DNS验证</div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="cert-email" class="form-label">邮箱地址</label>
                            <input type="email" class="form-control" id="cert-email" name="email" required
                                   placeholder="admin@domain.com">
                            <div class="form-text">用于Let's Encrypt通知和证书到期提醒</div>
                        </div>
                        <div class="alert alert-info">
                            <h6><i class="fas fa-info-circle"></i> DNS验证说明</h6>
                            <ul class="mb-0">
                                <li>系统会生成DNS TXT记录验证值</li>
                                <li>您需要手动添加TXT记录到域名DNS</li>
                                <li>验证完成后系统会自动签发证书</li>
                                <li>适用于所有类型的证书申请</li>
                            </ul>
                        </div>
                    </form>
                    
                    <!-- DNS验证步骤显示区域 -->
                    <div id="dns-validation-section" class="d-none mt-4">
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>DNS验证所需</strong><br>
                            请按照以下步骤添加DNS TXT记录来验证域名所有权：
                        </div>
                        
                        <div class="card">
                            <div class="card-header bg-light">
                                <h6 class="mb-0"><i class="fas fa-dns me-2"></i>DNS记录信息</h6>
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-sm-3"><strong>记录类型：</strong></div>
                                    <div class="col-sm-9">
                                        <code class="bg-light p-1">TXT</code>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-sm-3"><strong>记录名称：</strong></div>
                                    <div class="col-sm-9">
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="dns-record-name" readonly>
                                            <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard('dns-record-name')" title="复制">
                                                <i class="fas fa-copy"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-sm-3"><strong>记录值：</strong></div>
                                    <div class="col-sm-9">
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="dns-record-value" readonly>
                                            <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard('dns-record-value')" title="复制">
                                                <i class="fas fa-copy"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="alert alert-info mt-3">
                            <h6><i class="fas fa-info-circle me-2"></i>操作说明</h6>
                            <ol class="mb-0">
                                <li>复制上述DNS记录信息</li>
                                <li>登录您的域名DNS管理界面</li>
                                <li>添加TXT记录到DNS解析设置</li>
                                <li>等待DNS记录生效（通常5-10分钟）</li>
                                <li>点击"继续验证"按钮完成验证</li>
                            </ol>
                        </div>
                        
                        <div id="dns-validation-result" class="mt-3"></div>
                    </div>

                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" form="issue-cert-form" class="btn btn-primary" id="issue-cert-submit">
                        <i class="fas fa-certificate me-2"></i>开始申请
                    </button>
                    <button type="button" class="btn btn-success d-none" id="continue-validation-btn" onclick="continueValidation()">
                        <i class="fas fa-check me-2"></i>完成DNS验证
                    </button>
                    <button type="button" class="btn btn-outline-primary d-none" id="back-to-form-btn" onclick="backToForm()">
                        <i class="fas fa-arrow-left me-2"></i>返回表单
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 系统初始化模态框 -->
    <div class="modal fade" id="system-init-modal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-cogs me-2"></i>系统初始化
                    </h5>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info d-flex align-items-center">
                        <i class="fas fa-info-circle me-3 fs-4"></i>
                        <div>
                            <strong>首次使用检测</strong><br>
                            检测到系统尚未完成初始化，需要安装和配置必要的邮件服务组件。
                        </div>
                    </div>
                    
                    <h6 class="text-primary mb-3">
                        <i class="fas fa-download me-2"></i>系统将安装以下组件：
                    </h6>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="card h-100 border-success">
                                <div class="card-header bg-light">
                                    <small class="fw-bold text-success">邮件服务</small>
                                </div>
                                <div class="card-body py-2">
                                    <ul class="list-unstyled mb-0 small">
                                        <li class="mb-1"><i class="fas fa-check-circle text-success me-2"></i>Postfix (SMTP服务器)</li>
                                        <li class="mb-1"><i class="fas fa-check-circle text-success me-2"></i>Dovecot (IMAP/POP3服务器)</li>
                                        <li class="mb-1"><i class="fas fa-check-circle text-success me-2"></i>Rspamd (反垃圾邮件)</li>
                                        <li class="mb-1"><i class="fas fa-check-circle text-success me-2"></i>OpenDKIM (邮件认证)</li>
                                        <li class="mb-0"><i class="fas fa-check-circle text-success me-2"></i>acme.sh (SSL证书管理)</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card h-100 border-warning">
                                <div class="card-header bg-light">
                                    <small class="fw-bold text-warning">安全工具</small>
                                </div>
                                <div class="card-body py-2">
                                    <ul class="list-unstyled mb-0 small">
                                        <li class="mb-1"><i class="fas fa-check-circle text-success me-2"></i>UFW (防火墙)</li>
                                        <li class="mb-1"><i class="fas fa-check-circle text-success me-2"></i>Fail2ban (入侵防护)</li>
                                        <li class="mb-1"><i class="fas fa-check-circle text-success me-2"></i>DNS工具</li>
                                        <li class="mb-1"><i class="fas fa-check-circle text-success me-2"></i>系统工具</li>
                                        <li class="mb-0"><i class="fas fa-check-circle text-success me-2"></i>网络工具</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 初始化进度区域 -->
                    <div id="init-progress" class="d-none mt-4">
                        <div class="d-flex align-items-center mb-3">
                            <i class="fas fa-rocket text-primary me-2"></i>
                            <h6 class="mb-0 text-primary">初始化进度</h6>
                        </div>
                        <div class="progress mb-3" style="height: 20px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary" 
                                 role="progressbar" 
                                 style="width: 0%" 
                                 aria-valuenow="0" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                                <span class="progress-text">0%</span>
                            </div>
                        </div>
                        <div id="init-steps" class="border rounded p-3 bg-light"></div>
                    </div>
                </div>
                <div class="modal-footer bg-light">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-clock me-2 text-muted"></i>
                        <small class="text-muted me-auto">预计耗时：3-5分钟</small>
                        <button type="button" class="btn btn-primary px-4" id="init-system-btn">
                            <i class="fas fa-play me-2"></i>开始初始化
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

</body>
</html>
