<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESemail ç³»ç»Ÿé…ç½®</title>
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/css/dashboard.css" rel="stylesheet">
    <script src="/static/js/bootstrap.bundle.min.js"></script>
    <style>
        .setup-container {
            max-width: 800px;
            margin: 50px auto;
        }
        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
        }
        .step {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #dee2e6;
            color: #6c757d;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 10px;
            font-weight: bold;
            position: relative;
        }
        .step.active {
            background-color: #007bff;
            color: white;
        }
        .step.completed {
            background-color: #28a745;
            color: white;
        }
        .step::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50px;
            width: 60px;
            height: 2px;
            background-color: #dee2e6;
            transform: translateY(-50%);
        }
        .step:last-child::after {
            display: none;
        }
        .step.completed::after {
            background-color: #28a745;
        }
        .form-section {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .dns-record {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 10px;
            font-family: monospace;
            font-size: 14px;
        }
        .copy-button {
            margin-left: 10px;
        }
    </style>
</head>
<body class="bg-light">
    <div class="setup-container">
        <div class="text-center mb-4">
            <h1 class="display-4 text-primary">ğŸš€ ESemail</h1>
            <p class="lead">è½»é‡åŒ–é‚®å±€ç³»ç»Ÿé…ç½®å‘å¯¼</p>
        </div>

        <div class="step-indicator">
            <div class="step active" id="step-1">1</div>
            <div class="step" id="step-2">2</div>
            <div class="step" id="step-3">3</div>
            <div class="step" id="step-4">4</div>
        </div>

        <!-- æ­¥éª¤1: åŸºç¡€é…ç½® -->
        <div id="step1-content" class="form-section">
            <h3><i class="fas fa-cog"></i> æ­¥éª¤1: åŸºç¡€é…ç½®</h3>
            <p class="text-muted">è¯·å¡«å†™æ‚¨çš„é‚®ä»¶ç³»ç»ŸåŸºç¡€ä¿¡æ¯</p>
            
            <form id="basic-config-form">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">ä¸»åŸŸå *</label>
                            <input type="text" class="form-control" name="domain" placeholder="example.com" required>
                            <small class="form-text text-muted">æ‚¨è¦ç”¨äºé‚®ä»¶æœåŠ¡çš„ä¸»åŸŸå</small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">é‚®ä»¶æœåŠ¡å™¨ä¸»æœºå *</label>
                            <input type="text" class="form-control" name="hostname" placeholder="mail.example.com" required>
                            <small class="form-text text-muted">é‚®ä»¶æœåŠ¡å™¨çš„å®Œæ•´åŸŸå(FQDN)</small>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">ç®¡ç†å‘˜é‚®ç®± *</label>
                            <input type="email" class="form-control" name="admin_email" placeholder="admin@example.com" required>
                            <small class="form-text text-muted">ç³»ç»Ÿç®¡ç†å‘˜é‚®ç®±åœ°å€</small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">ç®¡ç†å‘˜å§“å *</label>
                            <input type="text" class="form-control" name="admin_name" placeholder="ç³»ç»Ÿç®¡ç†å‘˜" required>
                        </div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">ç®¡ç†å‘˜å¯†ç  *</label>
                    <input type="password" class="form-control" name="admin_pass" placeholder="è¯·è¾“å…¥è‡³å°‘6ä½å¯†ç " required minlength="6">
                    <small class="form-text text-muted">ç”¨äºç™»å½•ç®¡ç†ç•Œé¢å’Œç®¡ç†å‘˜é‚®ç®±</small>
                </div>
                
                <button type="submit" class="btn btn-primary">ä¸‹ä¸€æ­¥ <i class="fas fa-arrow-right"></i></button>
            </form>
        </div>

        <!-- æ­¥éª¤2: DNSé…ç½®æŒ‡å¼• -->
        <div id="step2-content" class="form-section d-none">
            <h3><i class="fas fa-globe"></i> æ­¥éª¤2: DNSè®°å½•é…ç½®</h3>
            <p class="text-muted">è¯·åœ¨æ‚¨çš„åŸŸåDNSç®¡ç†åå°æ·»åŠ ä»¥ä¸‹è®°å½•</p>
            
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                è¯·åœ¨æ‚¨çš„åŸŸåDNSç®¡ç†åå°ï¼ˆå¦‚Cloudflareã€é˜¿é‡Œäº‘DNSç­‰ï¼‰æ·»åŠ ä»¥ä¸‹è®°å½•
            </div>

            <h5>å¿…éœ€çš„DNSè®°å½•ï¼š</h5>
            
            <div class="dns-record">
                <strong>A è®°å½•</strong><br>
                åç§°: <code id="dns-a-name">mail</code><br>
                å€¼: <code id="dns-a-value">æ‚¨çš„æœåŠ¡å™¨IP</code>
                <button class="btn btn-sm btn-outline-secondary copy-button" onclick="copyToClipboard('dns-a-value')">å¤åˆ¶</button>
            </div>

            <div class="dns-record">
                <strong>MX è®°å½•</strong><br>
                åç§°: <code>@</code><br>
                å€¼: <code id="dns-mx-value">10 mail.example.com</code>
                <button class="btn btn-sm btn-outline-secondary copy-button" onclick="copyToClipboard('dns-mx-value')">å¤åˆ¶</button>
            </div>

            <div class="dns-record">
                <strong>TXT è®°å½• (SPF)</strong><br>
                åç§°: <code>@</code><br>
                å€¼: <code>v=spf1 mx ~all</code>
                <button class="btn btn-sm btn-outline-secondary copy-button" onclick="copyToClipboard(this.previousElementSibling)">å¤åˆ¶</button>
            </div>

            <div class="dns-record">
                <strong>TXT è®°å½• (DMARC)</strong><br>
                åç§°: <code id="dns-dmarc-name">_dmarc</code><br>
                å€¼: <code id="dns-dmarc-value">v=DMARC1; p=none; rua=mailto:dmarc@example.com</code>
                <button class="btn btn-sm btn-outline-secondary copy-button" onclick="copyToClipboard('dns-dmarc-value')">å¤åˆ¶</button>
            </div>

            <div class="alert alert-warning">
                <i class="fas fa-clock"></i>
                DNSè®°å½•å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿåˆ°å‡ å°æ—¶æ‰èƒ½ç”Ÿæ•ˆï¼Œè¯·è€å¿ƒç­‰å¾…
            </div>

            <button type="button" class="btn btn-secondary me-2" onclick="previousStep()">
                <i class="fas fa-arrow-left"></i> ä¸Šä¸€æ­¥
            </button>
            <button type="button" class="btn btn-primary" onclick="nextStep()">
                ä¸‹ä¸€æ­¥ <i class="fas fa-arrow-right"></i>
            </button>
        </div>

        <!-- æ­¥éª¤3: ç³»ç»Ÿåˆå§‹åŒ– -->
        <div id="step3-content" class="form-section d-none">
            <h3><i class="fas fa-server"></i> æ­¥éª¤3: ç³»ç»Ÿåˆå§‹åŒ–</h3>
            <p class="text-muted">æ­£åœ¨åˆå§‹åŒ–é‚®ä»¶æœåŠ¡å’Œç”ŸæˆDKIMå¯†é’¥</p>
            
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                ç³»ç»Ÿå°†è‡ªåŠ¨é…ç½®Postfixã€Dovecotã€Rspamdå’ŒOpenDKIMæœåŠ¡
            </div>

            <div id="init-progress" class="mb-3">
                <div class="progress mb-3">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%">0%</div>
                </div>
                <div id="init-steps"></div>
            </div>

            <div id="init-buttons">
                <button type="button" class="btn btn-secondary me-2" onclick="previousStep()">
                    <i class="fas fa-arrow-left"></i> ä¸Šä¸€æ­¥
                </button>
                <button type="button" class="btn btn-primary" id="init-system-btn" onclick="initializeSystem()">
                    <i class="fas fa-play"></i> å¼€å§‹åˆå§‹åŒ–
                </button>
            </div>
        </div>

        <!-- æ­¥éª¤4: DKIMé…ç½® -->
        <div id="step4-content" class="form-section d-none">
            <h3><i class="fas fa-key"></i> æ­¥éª¤4: DKIMè®°å½•é…ç½®</h3>
            <p class="text-muted">è¯·æ·»åŠ DKIM TXTè®°å½•ä»¥å¯ç”¨é‚®ä»¶ç­¾åè®¤è¯</p>
            
            <div class="alert alert-success">
                <i class="fas fa-check-circle"></i>
                ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼ç°åœ¨éœ€è¦é…ç½®DKIMè®°å½•
            </div>

            <div id="dkim-record-section">
                <h5>DKIM DNSè®°å½•ï¼š</h5>
                <div class="dns-record">
                    <strong>TXT è®°å½• (DKIM)</strong><br>
                    åç§°: <code id="dkim-record-name">default._domainkey.example.com</code><br>
                    å€¼: <code id="dkim-record-value">æ­£åœ¨è·å–...</code>
                    <button class="btn btn-sm btn-outline-secondary copy-button" onclick="copyToClipboard('dkim-record-value')">å¤åˆ¶</button>
                </div>
            </div>

            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle"></i>
                è¯·åŠ¡å¿…æ·»åŠ DKIMè®°å½•ï¼Œå¦åˆ™å‘é€çš„é‚®ä»¶å¯èƒ½è¢«æ ‡è®°ä¸ºåƒåœ¾é‚®ä»¶
            </div>

            <div class="text-center">
                <button type="button" class="btn btn-success btn-lg" onclick="completeSetup()">
                    <i class="fas fa-check"></i> å®Œæˆè®¾ç½®ï¼Œè¿›å…¥ç®¡ç†ç•Œé¢
                </button>
            </div>
        </div>
    </div>

    <script>
        let currentStep = 1;
        let setupConfig = {};

        document.addEventListener('DOMContentLoaded', function() {
            checkSetupStatus();
            
            document.getElementById('basic-config-form').addEventListener('submit', handleBasicConfig);
        });

        async function checkSetupStatus() {
            try {
                const response = await fetch('/api/v1/setup/status');
                const status = await response.json();
                
                if (status.is_setup) {
                    window.location.href = '/';
                    return;
                }
                
                if (status.step > 1) {
                    currentStep = status.step;
                    setupConfig.domain = status.domain;
                    setupConfig.admin_email = status.admin_email;
                    setupConfig.hostname = status.hostname;
                    showStep(currentStep);
                }
            } catch (error) {
                console.error('æ£€æŸ¥è®¾ç½®çŠ¶æ€å¤±è´¥:', error);
            }
        }

        async function handleBasicConfig(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            setupConfig = Object.fromEntries(formData.entries());
            
            // æ›´æ–°DNSè®°å½•æ˜¾ç¤º
            updateDNSRecords();
            
            nextStep();
        }

        function updateDNSRecords() {
            document.getElementById('dns-a-name').textContent = 'mail';
            document.getElementById('dns-mx-value').textContent = `10 ${setupConfig.hostname}`;
            document.getElementById('dns-dmarc-name').textContent = '_dmarc';
            document.getElementById('dns-dmarc-value').textContent = `v=DMARC1; p=none; rua=mailto:dmarc@${setupConfig.domain}`;
        }

        async function initializeSystem() {
            const btn = document.getElementById('init-system-btn');
            const progress = document.getElementById('init-progress');
            const stepsDiv = document.getElementById('init-steps');
            
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> åˆå§‹åŒ–ä¸­...';
            
            try {
                // é¦–å…ˆé…ç½®ç³»ç»Ÿ
                const configResponse = await fetch('/api/v1/setup/configure', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(setupConfig)
                });

                if (!configResponse.ok) {
                    throw new Error('ç³»ç»Ÿé…ç½®å¤±è´¥');
                }
                
                // ç„¶åè¿›è¡Œç³»ç»Ÿåˆå§‹åŒ–
                const initResponse = await fetch('/api/v1/system/init', { method: 'POST' });
                const result = await initResponse.json();
                
                const progressBar = progress.querySelector('.progress-bar');
                const totalSteps = result.steps.length;
                
                result.steps.forEach((step, index) => {
                    const progressPercent = ((index + 1) / totalSteps) * 100;
                    progressBar.style.width = progressPercent + '%';
                    progressBar.textContent = Math.round(progressPercent) + '%';
                    
                    const stepDiv = document.createElement('div');
                    stepDiv.className = `alert ${step.status === 'completed' ? 'alert-success' : step.status === 'failed' ? 'alert-danger' : 'alert-info'}`;
                    stepDiv.innerHTML = `<strong>${step.description}</strong>: ${step.status === 'completed' ? 'âœ“ å®Œæˆ' : step.status === 'failed' ? 'âœ— å¤±è´¥ - ' + step.error : 'â³ è¿›è¡Œä¸­'}`;
                    stepsDiv.appendChild(stepDiv);
                });
                
                if (result.success) {
                    progressBar.classList.remove('progress-bar-animated');
                    progressBar.classList.add('bg-success');
                    
                    setTimeout(() => {
                        nextStep();
                        loadDKIMRecord();
                    }, 2000);
                } else {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-redo"></i> é‡è¯•åˆå§‹åŒ–';
                }
            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±è´¥:', error);
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-redo"></i> é‡è¯•åˆå§‹åŒ–';
                
                const errorDiv = document.createElement('div');
                errorDiv.className = 'alert alert-danger';
                errorDiv.innerHTML = `<strong>é”™è¯¯</strong>: ${error.message}`;
                stepsDiv.appendChild(errorDiv);
            }
        }

        async function loadDKIMRecord() {
            try {
                const response = await fetch(`/api/v1/setup/dkim?domain=${setupConfig.domain}`);
                const data = await response.json();
                
                document.getElementById('dkim-record-name').textContent = data.record_name;
                document.getElementById('dkim-record-value').textContent = data.record_value;
            } catch (error) {
                console.error('è·å–DKIMè®°å½•å¤±è´¥:', error);
                document.getElementById('dkim-record-value').textContent = 'è·å–å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
            }
        }

        function nextStep() {
            if (currentStep < 4) {
                currentStep++;
                showStep(currentStep);
            }
        }

        function previousStep() {
            if (currentStep > 1) {
                currentStep--;
                showStep(currentStep);
            }
        }

        function showStep(step) {
            // éšè—æ‰€æœ‰æ­¥éª¤å†…å®¹
            for (let i = 1; i <= 4; i++) {
                document.getElementById(`step${i}-content`).classList.add('d-none');
                const stepIndicator = document.getElementById(`step-${i}`);
                stepIndicator.classList.remove('active', 'completed');
                
                if (i < step) {
                    stepIndicator.classList.add('completed');
                } else if (i === step) {
                    stepIndicator.classList.add('active');
                }
            }
            
            // æ˜¾ç¤ºå½“å‰æ­¥éª¤
            document.getElementById(`step${step}-content`).classList.remove('d-none');
        }

        function completeSetup() {
            window.location.href = '/';
        }

        function copyToClipboard(elementId) {
            let text;
            if (typeof elementId === 'string') {
                text = document.getElementById(elementId).textContent;
            } else {
                text = elementId.textContent;
            }
            
            navigator.clipboard.writeText(text).then(function() {
                // å¯ä»¥æ·»åŠ å¤åˆ¶æˆåŠŸçš„æç¤º
                const button = event.target;
                const originalText = button.textContent;
                button.textContent = 'å·²å¤åˆ¶!';
                button.classList.add('btn-success');
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.classList.remove('btn-success');
                    button.classList.add('btn-outline-secondary');
                }, 2000);
            });
        }
    </script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</body>
</html>